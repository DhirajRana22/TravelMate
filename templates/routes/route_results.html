{% extends 'base.html' %}
{% load static %}

{% block title %}Search Results - TravelMate{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-to-r from-blue-600 to-purple-700 text-white py-12 -mt-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2">Search Results</h1>
            <p class="text-xl opacity-90">{{ source }} to {{ destination }} • {{ travel_date|date:"M d, Y" }}</p>
        </div>
    </div>
</section>

<!-- Search Summary & Modify -->
<section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Search Summary -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">
                        <i class="fas fa-route mr-2 text-blue-500"></i>{{ source }} → {{ destination }}
                    </h2>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                        <span><i class="fas fa-calendar mr-1 text-green-500"></i>{{ travel_date|date:"l, M d, Y" }}</span>
                        <span><i class="fas fa-users mr-1 text-purple-500"></i>{{ passengers }} passenger{{ passengers|pluralize }}</span>
                        <span class="results-count"><i class="fas fa-info-circle mr-1 text-blue-500"></i>{{ schedules|length }} result{{ schedules|length|pluralize }} found</span>
                    </div>
                </div>
                
                <button onclick="toggleModifySearch()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-edit mr-2"></i>Modify Search
                </button>
            </div>
        </div>
        
        <!-- Modify Search Form (Hidden by default) -->
        <div id="modifySearchForm" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Modify Your Search</h3>
            <form method="get" action="{% url 'routes:route_results' %}" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <input type="text" name="source" value="{{ source }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <input type="text" name="destination" value="{{ destination }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" name="travel_date" value="{{ travel_date|date:'Y-m-d' }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-3 flex gap-2">
                    <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search Again
                    </button>
                    <button type="button" onclick="toggleModifySearch()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Results Section -->
<section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Filters Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Filters</h3>
                        <button id="clearFilters" class="text-sm text-blue-500 hover:text-blue-600">Clear All</button>
                    </div>
                    
                    <!-- Bus Type Filter -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Bus Type</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="bus-type" value="ac">
                                <span class="ml-2 text-sm text-gray-700">AC</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="bus-type" value="non_ac">
                                <span class="ml-2 text-sm text-gray-700">Non-AC</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="bus-type" value="sleeper">
                                <span class="ml-2 text-sm text-gray-700">Sleeper</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="bus-type" value="semi_sleeper">
                                <span class="ml-2 text-sm text-gray-700">Semi-Sleeper</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Price Range</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="price" value="low">
                                <span class="ml-2 text-sm text-gray-700">Under रू500</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="price" value="mid">
                                <span class="ml-2 text-sm text-gray-700">रू500 - रू1000</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="price" value="high">
                                <span class="ml-2 text-sm text-gray-700">Above रू1000</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Departure Time Filter -->
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Departure Time</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="time" value="morning">
                                <span class="ml-2 text-sm text-gray-700">Morning (6AM - 12PM)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="time" value="afternoon">
                                <span class="ml-2 text-sm text-gray-700">Afternoon (12PM - 6PM)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="time" value="evening">
                                <span class="ml-2 text-sm text-gray-700">Evening (6PM - 12AM)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-filter="time" value="night">
                                <span class="ml-2 text-sm text-gray-700">Night (12AM - 6AM)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Sort Options -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Sort By</h4>
                        <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="departure">Departure Time</option>
                            <option value="price">Price (Low to High)</option>
                            <option value="duration">Duration</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Results List -->
            <div class="lg:col-span-3">
                {% if schedules %}
                    <div class="space-y-6">
                        {% for schedule in schedules %}
                        <div class="schedule-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 {% if schedule.is_recommended %}border-l-4 border-l-yellow-500 bg-yellow-50{% endif %}" 
                             data-bus-type="{{ schedule.bus.bus_type }}" 
                             data-price="{{ schedule.base_fare }}" 
                             data-departure="{{ schedule.departure_time.hour }}">
                            
                            <!-- Schedule Header -->
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 border-b border-gray-200">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="mb-4 md:mb-0">
                                        <div class="flex items-center mb-2">
                                            <h3 class="text-xl font-bold text-gray-800 mr-3">{{ schedule.bus.bus_number }}</h3>
                                            <span class="px-3 py-1 bg-blue-500 text-white rounded-full text-sm font-medium">
                                                {{ schedule.bus.bus_type|title }}
                                            </span>
                                            {% if schedule.is_recommended %}
                                                 <span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-bold ml-2 animate-pulse">
                                                     <i class="fas fa-star mr-1"></i>RECOMMENDED
                                                 </span>
                                             {% endif %}
                                        </div>
                                        <p class="text-gray-600">{{ schedule.bus.operator|default:"TravelMate" }}</p>
                                        {% if schedule.recommendation_score %}
                                             <div class="text-sm text-yellow-600 font-semibold mt-1">
                                                 <i class="fas fa-thumbs-up mr-1"></i>{{ schedule.recommendation_score|floatformat:0 }}% match
                                             </div>
                                         {% endif %}
                                    </div>
                                    
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-green-600 mb-1">रू{{ schedule.base_fare }}</div>
                                        <div class="text-sm text-gray-600">per person</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Schedule Body -->
                            <div class="p-6">
                                <!-- Time Information -->
                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-gray-800">{{ schedule.departure_time|time:"g:i A" }}</div>
                                        <div class="text-sm text-gray-600 mt-1">{{ source }}</div>
                                        <div class="text-xs text-gray-500">Departure</div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="bg-blue-50 rounded-lg p-3">
                                            <div class="text-sm font-semibold text-blue-600 mb-1">{{ schedule.duration|default:"6h 30m" }}</div>
                                            <div class="h-1 bg-blue-500 rounded-full relative">
                                                <div class="absolute -right-1 -top-1 w-3 h-3 bg-blue-500 rounded-full"></div>
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">Direct</div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-gray-800">{{ schedule.arrival_time|time:"g:i A" }}</div>
                                        <div class="text-sm text-gray-600 mt-1">{{ destination }}</div>
                                        <div class="text-xs text-gray-500">Arrival</div>
                                    </div>
                                </div>
                                
                                <!-- Bus Details -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-users text-blue-500 text-lg mb-2"></i>
                                        <div class="text-sm font-semibold text-gray-800">{{ schedule.bus.total_seats }}</div>
                                        <div class="text-xs text-gray-600">Total Seats</div>
                                    </div>
                                    
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-chair text-green-500 text-lg mb-2"></i>
                                        <div class="text-sm font-semibold text-green-600">{{ schedule.available_seats }}</div>
                                        <div class="text-xs text-gray-600">Available</div>
                                    </div>
                                    
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <i class="fas fa-route text-purple-500 text-lg mb-2"></i>
                                        <div class="text-sm font-semibold text-gray-800">{{ schedule.route.distance|default:"200" }}km</div>
                                        <div class="text-xs text-gray-600">Distance</div>
                                    </div>
                                </div>
                                
                                <!-- Amenities -->
                                <div class="mb-6">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Amenities</h4>
                                    <div class="flex flex-wrap gap-2">
                                        {% if schedule.bus.is_ac %}
                                        <span class="inline-flex items-center px-2 py-1 bg-blue-50 text-blue-700 rounded-full text-xs">
                                            <i class="fas fa-snowflake mr-1"></i>AC
                                        </span>
                                        {% endif %}
                                        {% if schedule.bus.has_wifi %}
                                        <span class="inline-flex items-center px-2 py-1 bg-purple-50 text-purple-700 rounded-full text-xs">
                                            <i class="fas fa-wifi mr-1"></i>WiFi
                                        </span>
                                        {% endif %}
                                        {% if schedule.bus.has_charging %}
                                        <span class="inline-flex items-center px-2 py-1 bg-yellow-50 text-yellow-700 rounded-full text-xs">
                                            <i class="fas fa-charging-station mr-1"></i>Charging
                                        </span>
                                        {% endif %}
                                        {% if schedule.bus.has_entertainment %}
                                        <span class="inline-flex items-center px-2 py-1 bg-red-50 text-red-700 rounded-full text-xs">
                                            <i class="fas fa-tv mr-1"></i>Entertainment
                                        </span>
                                        {% endif %}
                                        <span class="inline-flex items-center px-2 py-1 bg-green-50 text-green-700 rounded-full text-xs">
                                            <i class="fas fa-shield-alt mr-1"></i>Insured
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <a href="{% url 'bookings:seat_selection' schedule.id %}?date={{ travel_date|date:'Y-m-d' }}" 
                                       class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-colors font-semibold text-center btn-book">
                                        <i class="fas fa-ticket-alt mr-2"></i>Book Now
                                    </a>
                                    
                                    <a href="{% url 'routes:schedule_detail' schedule.id %}" 
                                       class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors font-semibold text-center btn-view-seats">
                                        <i class="fas fa-eye mr-2"></i>View Details
                                    </a>
                                    
                                    <button onclick="shareSchedule('{{ schedule.id }}')" 
                                            class="bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors font-semibold">
                                        <i class="fas fa-share mr-2"></i>Share
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="flex justify-center mt-8">
                        <nav class="flex space-x-2">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}" 
                                   class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            {% endif %}
                            
                            <span class="bg-blue-500 text-white px-3 py-2 rounded">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                            
                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}" 
                                   class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            {% endif %}
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- No Results -->
                    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                        <div class="max-w-md mx-auto">
                            <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">No Routes Found</h3>
                            <p class="text-gray-600 mb-6">
                                We couldn't find any bus routes for your search criteria. 
                                Try adjusting your search parameters or check back later.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button onclick="toggleModifySearch()" 
                                        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                    <i class="fas fa-edit mr-2"></i>Modify Search
                                </button>
                                <a href="{% url 'routes:route_search' %}" 
                                   class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-search mr-2"></i>New Search
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
        const scheduleCards = document.querySelectorAll('.schedule-card');
        
        filterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });
        
        function applyFilters() {
            const busTypeFilters = Array.from(document.querySelectorAll('.filter-checkbox[data-filter="bus-type"]:checked')).map(cb => cb.value);
            const priceFilters = Array.from(document.querySelectorAll('.filter-checkbox[data-filter="price"]:checked')).map(cb => cb.value);
            const timeFilters = Array.from(document.querySelectorAll('.filter-checkbox[data-filter="time"]:checked')).map(cb => cb.value);
            
            scheduleCards.forEach(card => {
                let show = true;
                const busType = card.dataset.busType;
                const price = parseFloat(card.dataset.price);
                const departure = parseInt(card.dataset.departure);
                
                // Bus type filter
                if (busTypeFilters.length > 0 && !busTypeFilters.includes(busType)) {
                    show = false;
                }
                
                // Price filter
                if (priceFilters.length > 0) {
                    let priceMatch = false;
                    priceFilters.forEach(filter => {
                        if (filter === 'low' && price <= 500) priceMatch = true;
                        if (filter === 'mid' && price > 500 && price <= 1000) priceMatch = true;
                        if (filter === 'high' && price > 1000) priceMatch = true;
                    });
                    if (!priceMatch) show = false;
                }
                
                // Time filter
                if (timeFilters.length > 0) {
                    let timeMatch = false;
                    timeFilters.forEach(filter => {
                        if (filter === 'morning' && departure >= 6 && departure < 12) timeMatch = true;
                        if (filter === 'afternoon' && departure >= 12 && departure < 18) timeMatch = true;
                        if (filter === 'evening' && departure >= 18 && departure < 24) timeMatch = true;
                        if (filter === 'night' && (departure >= 0 && departure < 6)) timeMatch = true;
                    });
                    if (!timeMatch) show = false;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
            
            updateResultsCount();
        }
        
        function updateResultsCount() {
            const visibleCards = document.querySelectorAll('.schedule-card[style*="block"], .schedule-card:not([style*="none"])');
            const count = visibleCards.length;
            document.querySelector('.results-count').innerHTML = `<i class="fas fa-info-circle mr-1 text-blue-500"></i>${count} result${count !== 1 ? 's' : ''} found`;
        }
        
        // Clear filters
        document.getElementById('clearFilters').addEventListener('click', function() {
            filterCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            scheduleCards.forEach(card => {
                card.style.display = 'block';
            });
            updateResultsCount();
        });
        
        // Sort functionality
        document.getElementById('sortBy').addEventListener('change', function() {
            const sortBy = this.value;
            const container = document.querySelector('.space-y-6');
            const cards = Array.from(scheduleCards);
            
            cards.sort((a, b) => {
                switch(sortBy) {
                    case 'price':
                        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
                    case 'departure':
                        return parseInt(a.dataset.departure) - parseInt(b.dataset.departure);
                    default:
                        return 0;
                }
            });
            
            cards.forEach(card => container.appendChild(card));
        });
        
        // Add loading state to book buttons
        document.querySelectorAll('.btn-book, .btn-view-seats').forEach(btn => {
            btn.addEventListener('click', function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
                
                // Restore original text after a delay (in case of navigation issues)
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 3000);
            });
        });
        
        // Set minimum date for modify search
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="travel_date"]').setAttribute('min', today);
    });
    
    // Toggle modify search form
    function toggleModifySearch() {
        const form = document.getElementById('modifySearchForm');
        form.classList.toggle('hidden');
    }
    
    // Share schedule function
    function shareSchedule(scheduleId) {
        const url = window.location.origin + '/routes/schedule/' + scheduleId + '/';
        
        if (navigator.share) {
            navigator.share({
                title: 'Bus Schedule - TravelMate',
                text: 'Check out this bus schedule',
                url: url
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(url).then(() => {
                alert('Schedule link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link:', url);
            });
        }
    }
</script>
{% endblock %}