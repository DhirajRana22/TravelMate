{% extends 'base.html' %} {% load static %} {% block title %}Request Refund -
TravelMate{% endblock %} {% block content %}
<!-- Header -->
<section
  class="bg-gradient-to-r from-red-600 to-pink-700 text-white py-12 -mt-6"
>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <div
      class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-undo text-2xl"></i>
    </div>
    <h1 class="text-3xl md:text-4xl font-bold mb-2">Request Refund</h1>
    <p class="text-xl opacity-90">Submit a refund request for your payment</p>
  </div>
</section>

<!-- Refund Form -->
<section class="py-12 bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Payment Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-8">
          <h2
            class="text-xl font-bold text-gray-900 mb-6 border-b border-gray-200 pb-3"
          >
            <i class="fas fa-receipt mr-2 text-red-500"></i>Payment Summary
          </h2>

          <!-- Payment Amount -->
          <div
            class="text-center mb-6 p-4 bg-red-50 rounded-lg border border-red-200"
          >
            <div class="text-sm text-red-600 mb-1">Refund Amount</div>
            <div class="text-3xl font-bold text-red-600">
              रू{{ payment.amount|floatformat:2 }}
            </div>
          </div>

          <!-- Payment Details -->
          <div class="space-y-4">
            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-600 text-sm">Payment ID</span>
              <span class="font-mono font-semibold text-gray-900 text-sm"
                >{{ payment.payment_id }}</span
              >
            </div>

            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-600 text-sm">Transaction ID</span>
              <span class="font-mono font-semibold text-gray-900 text-sm"
                >{{ payment.transaction_id }}</span
              >
            </div>

            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-600 text-sm">Payment Method</span>
              <span class="font-semibold text-gray-900 text-sm"
                >{{ payment.get_payment_method_display }}</span
              >
            </div>

            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-600 text-sm">Payment Date</span>
              <span class="font-semibold text-gray-900 text-sm"
                >{{ payment.payment_date|date:"M d, Y" }}</span
              >
            </div>

            <div
              class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
            >
              <span class="text-gray-600 text-sm">Status</span>
              <span
                class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-semibold"
              >
                {{ payment.get_payment_status_display }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Refund Form -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            <i class="fas fa-file-alt mr-2 text-red-500"></i>Refund Request Form
          </h2>

          <!-- Booking Information -->
          <div class="bg-blue-50 rounded-xl p-6 mb-8 border border-blue-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              <i class="fas fa-bus mr-2 text-blue-500"></i>Booking Information
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-gray-600 mb-1">Booking ID</div>
                <div class="font-semibold text-gray-900">
                  {{ payment.booking.booking_id }}
                </div>
              </div>

              <div>
                <div class="text-sm text-gray-600 mb-1">Travel Date</div>
                <div class="font-semibold text-gray-900">
                  {{ payment.booking.travel_date|date:"M d, Y" }}
                </div>
              </div>

              <div>
                <div class="text-sm text-gray-600 mb-1">Route</div>
                <div class="font-semibold text-gray-900">
                  {{ payment.booking.bus_schedule.route.source }} → {{
                  payment.booking.bus_schedule.route.destination }}
                </div>
              </div>

              <div>
                <div class="text-sm text-gray-600 mb-1">Bus Number</div>
                <div class="font-semibold text-gray-900">
                  {{ payment.booking.bus_schedule.bus.bus_number }}
                </div>
              </div>
            </div>
          </div>

          <!-- Refund Form -->
          <form method="POST" class="space-y-6">
            {% csrf_token %}

            <!-- Reason for Refund -->
            <div>
              <label
                for="{{ form.reason.id_for_label }}"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                <i class="fas fa-exclamation-circle text-red-500 mr-1"></i
                >Reason for Refund *
              </label>
              <select
                name="reason"
                id="{{ form.reason.id_for_label }}"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
              >
                <option value="">Select a reason</option>
                <option value="trip_cancelled">
                  Trip Cancelled by Operator
                </option>
                <option value="emergency">Personal Emergency</option>
                <option value="schedule_change">Schedule Change</option>
                <option value="medical_emergency">Medical Emergency</option>
                <option value="weather_conditions">Weather Conditions</option>
                <option value="other">Other</option>
              </select>
              {% if form.reason.help_text %}
              <div class="text-sm text-gray-600 mt-1">
                {{ form.reason.help_text }}
              </div>
              {% endif %} {% if form.reason.errors %}
              <div class="text-red-600 text-sm mt-1">
                {% for error in form.reason.errors %}
                <div>{{ error }}</div>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Additional Details -->
            <div>
              <label
                for="{{ form.description.id_for_label }}"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                <i class="fas fa-comment-alt text-blue-500 mr-1"></i>Additional
                Details
              </label>
              <textarea
                name="description"
                id="{{ form.description.id_for_label }}"
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-vertical"
                placeholder="Please provide additional details about your refund request. Include any relevant information that might help us process your request faster."
              ></textarea>
              {% if form.description.help_text %}
              <div class="text-sm text-gray-600 mt-1">
                {{ form.description.help_text }}
              </div>
              {% endif %} {% if form.description.errors %}
              <div class="text-red-600 text-sm mt-1">
                {% for error in form.description.errors %}
                <div>{{ error }}</div>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <!-- Refund Policy Notice -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h4 class="font-semibold text-yellow-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Refund Policy
              </h4>
              <ul class="text-sm text-yellow-700 space-y-1">
                <li>
                  • Refund requests are processed within 3-5 business days
                </li>
                <li>
                  • Cancellation fees may apply based on timing and reason
                </li>
                <li>• Refunds are processed to the original payment method</li>
                <li>• You will receive email updates on your refund status</li>
              </ul>
            </div>

            <!-- Processing Time Notice -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="font-semibold text-blue-800 mb-2">
                <i class="fas fa-clock mr-2"></i>Processing Timeline
              </h4>
              <div
                class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700"
              >
                <div class="text-center">
                  <div class="font-semibold">1-2 Days</div>
                  <div>Request Review</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold">3-5 Days</div>
                  <div>Processing</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold">5-7 Days</div>
                  <div>Refund Credit</div>
                </div>
              </div>
            </div>

            <!-- Terms Agreement -->
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start">
                <input
                  type="checkbox"
                  name="terms_agreed"
                  required
                  class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300 rounded mt-1 mr-3"
                />
                <span class="text-sm text-gray-600 leading-relaxed">
                  I understand and agree to the
                  <a
                    href="{% url 'home:terms' %}"
                    class="text-red-600 hover:text-red-700 font-medium"
                    target="_blank"
                    >refund policy</a
                  >
                  and acknowledge that processing fees may apply. I confirm that
                  the information provided is accurate and complete.
                </span>
              </label>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
              <button
                type="submit"
                class="flex-1 bg-red-500 text-white py-4 rounded-xl font-semibold text-lg hover:bg-red-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
              >
                <i class="fas fa-paper-plane mr-2"></i>Submit Refund Request
              </button>

              <a
               <a href="{% url 'payments:payment_detail' payment.payment_id %}"
                class="flex-1 bg-gray-500 text-white py-4 rounded-xl font-semibold text-lg hover:bg-gray-600 transition-colors text-center"
              >
                <i class="fas fa-times mr-2"></i>Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Help Section -->
<section class="py-12 bg-white">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-gray-50 rounded-2xl p-8">
      <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">
        <i class="fas fa-question-circle text-blue-500 mr-2"></i>Need Help with
        Your Refund?
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <h4 class="font-semibold text-gray-800 mb-4">Common Questions</h4>
          <ul class="space-y-3 text-sm text-gray-600">
            <li class="flex items-start">
              <i class="fas fa-question text-blue-500 mr-2 mt-1"></i>
              <div>
                <strong>How long does a refund take?</strong><br />
                Refunds are typically processed within 5-7 business days after
                approval.
              </div>
            </li>
            <li class="flex items-start">
              <i class="fas fa-question text-blue-500 mr-2 mt-1"></i>
              <div>
                <strong>Are there any cancellation fees?</strong><br />
                Fees may apply based on the timing and reason for cancellation.
              </div>
            </li>
            <li class="flex items-start">
              <i class="fas fa-question text-blue-500 mr-2 mt-1"></i>
              <div>
                <strong>Can I track my refund status?</strong><br />
                Yes, you'll receive email updates and can check status in your
                account.
              </div>
            </li>
          </ul>
        </div>

        <div>
          <h4 class="font-semibold text-gray-800 mb-4">Contact Support</h4>
          <div class="space-y-3">
            <a
              href="tel:+9779847435111"
              class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-100 transition-colors"
            >
              <i class="fas fa-phone text-green-500 mr-3"></i>
              <div>
                <div class="font-medium text-gray-900">Call Support</div>
                <div class="text-sm text-gray-600">+977 9847435111</div>
              </div>
            </a>

            <a
              href="mailto:support@travelmate.com"
              class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-100 transition-colors"
            >
              <i class="fas fa-envelope text-blue-500 mr-3"></i>
              <div>
                <div class="font-medium text-gray-900">Email Support</div>
                <div class="text-sm text-gray-600">support@travelmate.com</div>
              </div>
            </a>

            <a
              href="{% url 'home:contact' %}"
              class="flex items-center p-3 bg-white rounded-lg hover:bg-gray-100 transition-colors"
            >
              <i class="fas fa-comments text-purple-500 mr-3"></i>
              <div>
                <div class="font-medium text-gray-900">Live Chat</div>
                <div class="text-sm text-gray-600">Available 24/7</div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Auto-resize textarea
    const textarea = document.querySelector('textarea[name="description"]');
    if (textarea) {
      textarea.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });
    }

    // Form validation
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", function (e) {
        const reasonSelect = document.querySelector('select[name="reason"]');
        const termsCheckbox = document.querySelector(
          'input[name="terms_agreed"]'
        );

        // Check reason selection
        if (!reasonSelect.value) {
          e.preventDefault();
          showToast("Please select a reason for the refund.", "error");
          reasonSelect.focus();
          return false;
        }

        // Check terms agreement
        if (!termsCheckbox.checked) {
          e.preventDefault();
          showToast("Please agree to the refund policy terms.", "error");
          termsCheckbox.focus();
          return false;
        }

        // Confirm submission
        if (
          !confirm(
            "Are you sure you want to submit this refund request? This action cannot be undone."
          )
        ) {
          e.preventDefault();
          return false;
        }

        // Add loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting Request...';
        submitBtn.disabled = true;
      });
    }

    // Show/hide additional details based on reason
    const reasonSelect = document.querySelector('select[name="reason"]');
    const descriptionTextarea = document.querySelector(
      'textarea[name="description"]'
    );

    if (reasonSelect && descriptionTextarea) {
      reasonSelect.addEventListener("change", function () {
        if (this.value === "other") {
          descriptionTextarea.required = true;
          descriptionTextarea.placeholder =
            "Please provide detailed information about your reason for refund request.";
        } else {
          descriptionTextarea.required = false;
          descriptionTextarea.placeholder =
            "Please provide additional details about your refund request. Include any relevant information that might help us process your request faster.";
        }
      });
    }
  });

  // Show toast notification
  function showToast(message, type) {
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
      type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
    } min-w-80 transform translate-x-full transition-transform duration-300`;

    toast.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-${
                      type === "success" ? "check" : "exclamation"
                    }-circle mr-2"></i>
                    ${message}
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
      toast.classList.remove("translate-x-full");
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
      toast.classList.add("translate-x-full");
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 300);
    }, 3000);
  }
</script>
{% endblock %}
