{% extends 'base.html' %}
{% load static %}

{% block title %}Payment History - TravelMate{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-to-r from-purple-600 to-blue-700 text-white py-12 -mt-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold mb-2">Payment History</h1>
                <p class="text-xl opacity-90">Track all your payments and transactions</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="exportPayments()" 
                        class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
                <button onclick="refreshPayments()" 
                        class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Statistics -->
<section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Payments -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-2xl font-bold">{{ total_payments|default:0 }}</div>
                        <div class="text-purple-100">Total Payments</div>
                    </div>
                    <i class="fas fa-credit-card text-3xl text-purple-200"></i>
                </div>
            </div>
            
            <!-- Successful Payments -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-2xl font-bold">{{ successful_payments|default:0 }}</div>
                        <div class="text-green-100">Successful</div>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-200"></i>
                </div>
            </div>
            
            <!-- Total Amount -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-2xl font-bold">रू{{ total_amount|default:0|floatformat:0 }}</div>
                        <div class="text-blue-100">Total Amount</div>
                    </div>
                    <i class="fas fa-money-bill-wave text-3xl text-blue-200"></i>
                </div>
            </div>
            
            <!-- Pending Refunds -->
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-2xl font-bold">{{ pending_refunds|default:0 }}</div>
                        <div class="text-orange-100">Pending Refunds</div>
                    </div>
                    <i class="fas fa-undo text-3xl text-orange-200"></i>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-filter mr-2 text-blue-500"></i>Filter Payments
            </h3>
            
            <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" name="search" value="{{ request.GET.search }}" 
                           placeholder="Transaction ID, Booking ID..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Status</option>
                        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
                        <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Refunded</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select name="method" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Methods</option>
                        <option value="esewa" {% if request.GET.method == 'esewa' %}selected{% endif %}>eSewa</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <select name="date_range" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Time</option>
                        <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>This Month</option>
                        <option value="year" {% if request.GET.date_range == 'year' %}selected{% endif %}>This Year</option>
                    </select>
                </div>
                
                <div class="md:col-span-4 flex gap-2">
                    <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-search mr-2"></i>Apply Filters
                    </button>
                    
                    {% if request.GET %}
                        <a href="{% url 'payments:payment_history' %}" 
                           class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>Clear Filters
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Payment List -->
<section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {% if payments %}
            <div id="payment-list" class="space-y-6">
                {% for payment in payments %}
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden">
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <!-- Payment Info -->
                            <div class="lg:col-span-2">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                                            {{ payment.booking.bus_schedule.route.source }} → {{ payment.booking.bus_schedule.route.destination }}
                                        </h3>
                                        <p class="text-sm text-gray-600">{{ payment.booking.travel_date|date:"M d, Y" }}</p>
                                    </div>
                                    
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-gray-900">रू{{ payment.amount|floatformat:2 }}</div>
                                        <div class="text-sm text-gray-600">{{ payment.payment_date|date:"M d, Y" }}</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Booking ID:</span>
                                        <span class="font-semibold text-gray-900">{{ payment.booking.booking_id }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Transaction ID:</span>
                                        <span class="font-mono font-semibold text-gray-900 bg-gray-100 px-2 py-1 rounded">{{ payment.transaction_id }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Method & Status -->
                            <div class="flex flex-col justify-between">
                                <div>
                                    <div class="flex items-center mb-2">
                                        <div class="w-6 h-6 bg-green-500 rounded flex items-center justify-center mr-2">
                                            <i class="fas fa-mobile-alt text-white text-xs"></i>
                                        </div>
                                        <span class="font-medium text-gray-900">{{ payment.get_payment_method_display }}</span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        {% if payment.payment_status == 'completed' %}
                                            <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                                                <i class="fas fa-check-circle mr-1"></i>Completed
                                            </span>
                                        {% elif payment.payment_status == 'pending' %}
                                            <span class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">
                                                <i class="fas fa-clock mr-1"></i>Pending
                                            </span>
                                        {% elif payment.payment_status == 'failed' %}
                                            <span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">
                                                <i class="fas fa-times-circle mr-1"></i>Failed
                                            </span>
                                        {% elif payment.payment_status == 'refunded' %}
                                            <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                                                <i class="fas fa-undo mr-1"></i>Refunded
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex flex-col gap-2">
                                <a href="{% url 'payments:payment_detail' payment.payment_id %}" 
                                   class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-center text-sm font-medium">
                                    <i class="fas fa-eye mr-2"></i>View Details
                                </a>
                                
                                {% if payment.payment_status == 'completed' and not payment.refund_requested %}
                                    <button onclick="requestRefund('{{ payment.payment_id }}')" 
                                            class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors text-sm font-medium">
                                        <i class="fas fa-undo mr-2"></i>Request Refund
                                    </button>
                                {% endif %}
                                
                                {% if payment.payment_status == 'completed' %}
                                    <a href="{% url 'bookings:download_ticket' payment.booking.booking_id %}" 
                                       class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-center text-sm font-medium">
                                        <i class="fas fa-download mr-2"></i>Download Ticket
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <div class="flex justify-center mt-8">
                    <nav class="flex space-x-2">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        {% endif %}
                        
                        <span class="bg-blue-500 text-white px-3 py-2 rounded">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="bg-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-400">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                <div class="max-w-md mx-auto">
                    <i class="fas fa-credit-card text-6xl text-gray-300 mb-6"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Payments Found</h3>
                    <p class="text-gray-600 mb-6">
                        {% if request.GET %}
                            No payments match your search criteria. Try adjusting your filters.
                        {% else %}
                            You haven't made any payments yet. Start by booking a bus ticket.
                        {% endif %}
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <a href="{% url 'routes:route_search' %}" 
                           class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-search mr-2"></i>Book a Ticket
                        </a>
                        {% if request.GET %}
                            <a href="{% url 'payments:payment_history' %}" 
                               class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-times mr-2"></i>Clear Filters
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</section>

<!-- Refund Request Modal -->
<div id="refundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 w-full">
        <h3 class="text-xl font-bold text-gray-900 mb-4">
            <i class="fas fa-undo text-orange-500 mr-2"></i>Request Refund
        </h3>
        
        <form id="refundForm">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Refund</label>
                <select name="reason" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">Select a reason</option>
                    <option value="trip_cancelled">Trip Cancelled</option>
                    <option value="emergency">Emergency</option>
                    <option value="schedule_change">Schedule Change</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Details</label>
                <textarea name="details" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                          placeholder="Please provide additional details about your refund request..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" 
                        class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                    Submit Request
                </button>
                <button type="button" onclick="hideRefundModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6">
        <div class="flex items-center">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mr-3"></i>
            <span class="text-gray-700 font-medium">Loading...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPaymentId = null;
    
    // Request refund
    function requestRefund(paymentId) {
        currentPaymentId = paymentId;
        document.getElementById('refundModal').classList.remove('hidden');
    }
    
    // Hide refund modal
    function hideRefundModal() {
        document.getElementById('refundModal').classList.add('hidden');
        currentPaymentId = null;
        document.getElementById('refundForm').reset();
    }
    
    // Handle refund form submission
    document.getElementById('refundForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentPaymentId) return;
        
        const formData = new FormData(this);
        
        fetch(`/payments/refund/${currentPaymentId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Refund request submitted successfully!', 'success');
                hideRefundModal();
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast(data.message || 'Failed to submit refund request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        });
    });
    
    // Export payments
    function exportPayments() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'csv');
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }
    
    // Refresh payments
    function refreshPayments() {
        showLoading();
        location.reload();
    }
    
    // Show loading spinner
    function showLoading() {
        document.getElementById('loading-spinner').classList.remove('hidden');
    }
    
    // Show toast notification
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        } min-w-80 transform translate-x-full transition-transform duration-300`;
        
        toast.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle mr-2"></i>
                    ${message}
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 3000);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'f':
                    e.preventDefault();
                    document.querySelector('input[name="search"]').focus();
                    break;
                case 'r':
                    e.preventDefault();
                    refreshPayments();
                    break;
            }
        }
    });
    
    // Auto-refresh every 5 minutes for pending payments
    if (document.querySelector('.bg-yellow-100')) {
        setInterval(() => {
            refreshPayments();
        }, 300000); // 5 minutes
    }
</script>
{% endblock %}