{% extends 'base.html' %} {% load static %} {% block title %}Process Payment -
TravelMate{% endblock %} {% block content %}
<!-- Header -->
<section
  class="bg-gradient-to-r from-green-600 to-emerald-700 text-white py-12 -mt-6"
>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <div
      class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-credit-card text-2xl"></i>
    </div>
    <h1 class="text-3xl md:text-4xl font-bold mb-2">Process Payment</h1>
    <p class="text-xl opacity-90">
      Complete your booking with secure payment processing
    </p>
  </div>
</section>

<!-- Payment Processing -->
<section class="py-12 bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Payment Steps -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
      <!-- Steps Header -->
      <div class="bg-gray-50 p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <!-- Step 1 -->
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm mr-3"
            >
              <i class="fas fa-check"></i>
            </div>
            <div>
              <div class="text-sm font-semibold text-blue-600">
                Booking Details
              </div>
              <div class="text-xs text-gray-500">Completed</div>
            </div>
          </div>

          <!-- Connector -->
          <div class="flex-1 h-0.5 bg-blue-500 mx-4"></div>

          <!-- Step 2 -->
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm mr-3"
            >
              <i class="fas fa-check"></i>
            </div>
            <div>
              <div class="text-sm font-semibold text-blue-600">
                Seat Selection
              </div>
              <div class="text-xs text-gray-500">Completed</div>
            </div>
          </div>

          <!-- Connector -->
          <div class="flex-1 h-0.5 bg-green-500 mx-4"></div>

          <!-- Step 3 -->
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold text-sm mr-3"
            >
              3
            </div>
            <div>
              <div class="text-sm font-semibold text-green-600">Payment</div>
              <div class="text-xs text-gray-500">In Progress</div>
            </div>
          </div>

          <!-- Connector -->
          <div class="flex-1 h-0.5 bg-gray-300 mx-4"></div>

          <!-- Step 4 -->
          <div class="flex items-center">
            <div
              class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-semibold text-sm mr-3"
            >
              4
            </div>
            <div>
              <div class="text-sm font-semibold text-gray-600">
                Confirmation
              </div>
              <div class="text-xs text-gray-500">Pending</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Content -->
      <div class="p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Booking Summary -->
          <div class="lg:col-span-1">
            <div class="bg-gray-50 rounded-xl p-6 sticky top-8">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-receipt mr-2 text-green-500"></i>Booking
                Summary
              </h3>

              <!-- Route -->
              <div class="text-center mb-6">
                <div class="flex items-center justify-center">
                  <span class="text-lg font-bold text-gray-800"
                    >{{ booking.bus_schedule.route.source }}</span
                  >
                  <i class="fas fa-arrow-right text-green-500 mx-3"></i>
                  <span class="text-lg font-bold text-gray-800"
                    >{{ booking.bus_schedule.route.destination }}</span
                  >
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  {{ booking.travel_date|date:"M d, Y" }}
                </div>
              </div>

              <!-- Details -->
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-600">Bus Number</span>
                  <span class="font-semibold text-gray-900"
                    >{{ booking.bus_schedule.bus.bus_number }}</span
                  >
                </div>

                <div class="flex justify-between">
                  <span class="text-gray-600">Departure</span>
                  <span class="font-semibold text-gray-900"
                    >{{ booking.departure_time|time:"g:i A" }}</span
                  >
                </div>

                <div class="flex justify-between">
                  <span class="text-gray-600">Passenger</span>
                  <span class="font-semibold text-gray-900"
                    >{{ booking.passenger_name }}</span
                  >
                </div>

                <div class="flex justify-between">
                  <span class="text-gray-600">Seats</span>
                  <div class="flex flex-wrap gap-1">
                    {% for seat in booking.seats.all %}
                    <span
                      class="bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold"
                    >
                      {{ seat.seat_number }}
                    </span>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <!-- Price Breakdown -->
              <div class="border-t border-gray-200 pt-4 mt-6">
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Ticket Price</span>
                    <span class="text-gray-900">रू{{ booking.subtotal }}</span>
                  </div>

                  {% if booking.service_fee %}
                  <div class="flex justify-between">
                    <span class="text-gray-600">Service Fee</span>
                    <span class="text-gray-900"
                      >रू{{ booking.service_fee }}</span
                    >
                  </div>
                  {% endif %}

                  <div class="border-t border-gray-200 pt-2 mt-2">
                    <div class="flex justify-between text-lg font-bold">
                      <span class="text-gray-800">Total Amount</span>
                      <span class="text-green-600"
                        >रू{{ booking.total_fare }}</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Form -->
          <div class="lg:col-span-2">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">
              <i class="fas fa-lock mr-2 text-green-500"></i>Secure Payment
              Processing
            </h3>

            <form id="paymentForm" method="POST">
              {% csrf_token %}

              <!-- Payment Method Selection -->
              <div class="mb-8">
                <h4 class="font-semibold text-gray-800 mb-4">
                  Select Payment Method
                </h4>

                <div class="grid grid-cols-1 gap-4">
                  <!-- eSewa -->
                  <label class="payment-method-option cursor-pointer">
                    <input
                      type="radio"
                      name="payment_method"
                      value="esewa"
                      class="sr-only"
                      required
                      checked
                    />
                    <div
                      class="border-2 border-green-500 rounded-xl p-6 bg-green-50"
                    >
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                          <div
                            class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mr-4"
                          >
                            <i class="fas fa-mobile-alt text-white text-lg"></i>
                          </div>
                          <div>
                            <div class="font-semibold text-gray-900 text-lg">eSewa</div>
                            <div class="text-sm text-gray-600">
                              Digital Wallet - Instant Confirmation
                            </div>
                          </div>
                        </div>
                        <div
                          class="method-radio w-5 h-5 border-2 border-green-500 rounded-full bg-green-500"
                        ></div>
                      </div>
                      <div class="text-sm text-gray-700">
                        <div class="flex items-center mb-2">
                          <i class="fas fa-check text-green-600 mr-2"></i>
                          <strong>Instant payment confirmation</strong>
                        </div>
                        <div class="flex items-center mb-2">
                          <i class="fas fa-shield-alt text-green-600 mr-2"></i>
                          Secure and encrypted
                        </div>
                        <div class="flex items-center">
                          <i class="fas fa-ticket-alt text-green-600 mr-2"></i>
                          Ticket confirmed immediately after payment
                        </div>
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Security Notice -->
              <div
                class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6"
              >
                <div class="flex items-start">
                  <i class="fas fa-shield-alt text-blue-500 mt-1 mr-3"></i>
                  <div>
                    <h5 class="font-semibold text-blue-800 mb-2">
                      Secure Payment Processing
                    </h5>
                    <ul class="text-sm text-blue-700 space-y-1">
                      <li>
                        • All payments are processed through secure, encrypted
                        channels
                      </li>
                      <li>
                        • Your financial information is protected with
                        bank-grade security
                      </li>
                      <li>• 100% refund guarantee for failed transactions</li>
                      <li>• 24/7 customer support for payment assistance</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Terms Agreement -->
              <div class="mb-6">
                <label class="flex items-start">
                  <input
                    type="checkbox"
                    name="terms_agreed"
                    required
                    class="h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-1 mr-3"
                  />
                  <span class="text-sm text-gray-600 leading-relaxed">
                    I agree to the
                    <a
                      href="{% url 'home:terms' %}"
                      class="text-green-600 hover:text-green-700 font-medium"
                      target="_blank"
                      >Terms and Conditions</a
                    >
                    and
                    <a
                      href="{% url 'home:privacy' %}"
                      class="text-green-600 hover:text-green-700 font-medium"
                      target="_blank"
                      >Privacy Policy</a
                    >. I understand the payment and cancellation policies.
                  </span>
                </label>
              </div>

              <!-- Payment Button -->
              <button
                type="submit"
                id="payButton"
                disabled
                class="w-full bg-green-500 text-white py-4 rounded-xl font-semibold text-lg hover:bg-green-600 transition-all duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none"
              >
                <i class="fas fa-lock mr-2"></i>Pay रू{{ booking.total_fare|floatformat:2 }}
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Help Section -->
<section class="py-12 bg-white">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
    <h3 class="text-2xl font-bold text-gray-900 mb-4">
      Need Help with Payment?
    </h3>
    <p class="text-gray-600 mb-6">
      Our customer support team is available 24/7 to assist you with any
      payment-related questions.
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a
        href="tel:+9779847435111"
        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors"
      >
        <i class="fas fa-phone mr-2"></i>Call Support
      </a>
      <a
        href="{% url 'home:contact' %}"
        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors"
      >
        <i class="fas fa-envelope mr-2"></i>Contact Us
      </a>
    </div>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const payButton = document.getElementById("payButton");
    const paymentForm = document.getElementById("paymentForm");
    const bookingFare = {{ booking.total_fare|floatformat:2 }};
    const paymentMethods = document.querySelectorAll(
      'input[name="payment_method"]'
    );
    const termsCheckbox = document.querySelector('input[name="terms_agreed"]');

    // Payment method selection
    paymentMethods.forEach((method) => {
      method.addEventListener("change", function () {
        // Remove previous selection
        document
          .querySelectorAll(".payment-method-option")
          .forEach((option) => {
            const div = option.querySelector("div");
            const radio = option.querySelector(".method-radio");
            div.classList.remove("border-green-500", "bg-green-50");
            radio.classList.remove("bg-green-500", "border-green-500");
            radio.classList.add("border-gray-300");
          });

        // Add selection to clicked method
        const parentLabel = this.closest(".payment-method-option");
        const div = parentLabel.querySelector("div");
        const radio = parentLabel.querySelector(".method-radio");
        div.classList.add("border-green-500", "bg-green-50");
        radio.classList.remove("border-gray-300");
        radio.classList.add("bg-green-500", "border-green-500");

        updatePayButton();
      });
    });

    // Terms checkbox
    termsCheckbox.addEventListener("change", updatePayButton);

    function updatePayButton() {
      const selectedMethod = document.querySelector(
        'input[name="payment_method"]:checked'
      );
      const termsAccepted = termsCheckbox.checked;

      if (selectedMethod && termsAccepted) {
        payButton.disabled = false;
        payButton.classList.remove("disabled:bg-gray-400");
      } else {
        payButton.disabled = true;
        payButton.classList.add("disabled:bg-gray-400");
      }
    }

    // Form submission
    paymentForm.addEventListener("submit", function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return false;
      }

      processPayment(this);
    });

    function validateForm() {
      const selectedMethod = document.querySelector(
        'input[name="payment_method"]:checked'
      );
      const termsAccepted = termsCheckbox.checked;

      if (!selectedMethod) {
        alert("Please select a payment method.");
        return false;
      }

      if (!termsAccepted) {
        alert("Please agree to the terms and conditions.");
        return false;
      }

      return true;
    }

    function processPayment(form) {
      const formData = new FormData(form);

      // Show loading state
      payButton.disabled = true;
      payButton.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Processing Payment...';

      fetch('{% url "payments:process_payment" payment.payment_id %}', {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Handle eSewa payment
            if (data.payment_method === "esewa") {
              submitEsewaPayment(data.esewa_data, data.esewa_url);
            } else {
              // Fallback just in case; redirect to success
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              } else {
                window.location.href = '{% url "payments:payment_success" payment.payment_id %}';
              }
            }
          } else {
            showToast(
              "Payment failed: " + (data.error || "Unknown error"),
              "error"
            );
            // Reset button
            payButton.disabled = false;
            payButton.innerHTML =
              `<i class="fas fa-lock mr-2"></i>Pay रू${bookingFare.toFixed(2)}`;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          showToast("Payment processing failed. Please try again.", "error");
          // Reset button
          payButton.disabled = false;
          payButton.innerHTML =
            `<i class="fas fa-lock mr-2"></i>Pay रू${bookingFare.toFixed(2)}`;
        });
    }

    function submitEsewaPayment(esewaData, esewaUrl) {
      // Create a form dynamically for eSewa submission
      const form = document.createElement("form");
      form.method = "POST";
      form.action = esewaUrl;
      form.style.display = "none";

      // Add all eSewa parameters as hidden inputs
      Object.keys(esewaData).forEach((key) => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = esewaData[key];
        form.appendChild(input);
      });

      // Append form to body and submit
      document.body.appendChild(form);
      form.submit();
    }

    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Show toast notification
    function showToast(message, type) {
      const toast = document.createElement("div");
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === "success" ? "bg-green-500 text-white" : "bg-red-500 text-white"
      } min-w-80 transform translate-x-full transition-transform duration-300`;

      toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${
                          type === "success" ? "check" : "exclamation"
                        }-circle mr-2"></i>
                        ${message}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

      document.body.appendChild(toast);

      // Animate in
      setTimeout(() => {
        toast.classList.remove("translate-x-full");
      }, 100);

      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.classList.add("translate-x-full");
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 300);
      }, 3000);
    }
  });
</script>
{% endblock %}
