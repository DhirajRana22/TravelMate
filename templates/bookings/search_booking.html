{% extends 'base.html' %} {% load static %} {% block title %}Search Booking -
TravelMate{% endblock %} {% block content %}
<!-- Header -->
<section
  class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-16 -mt-6"
>
  <div class="container mx-auto px-4">
    <div class="text-center">
      <div
        class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <i class="fas fa-search text-2xl"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Search Booking</h1>
      <p class="text-xl opacity-90">
        Find your booking using multiple search options
      </p>
    </div>
  </div>
</section>

<!-- Search Interface -->
<section class="py-12 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Search Card -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-8">
          <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">
            Find Your Booking
          </h2>
          <p class="text-gray-600 text-center mb-8">
            Choose a search method to locate your booking details
          </p>

          <!-- Search Methods -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div
              class="method-card border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 text-center active"
              data-method="booking_id"
            >
              <div
                class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-ticket-alt text-blue-600 text-2xl"></i>
              </div>
              <h3 class="font-semibold text-gray-800 mb-2">Booking ID</h3>
              <p class="text-sm text-gray-600">
                Search using your booking reference number
              </p>
            </div>

            <div
              class="method-card border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 text-center"
              data-method="phone"
            >
              <div
                class="w-16 h-16 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-phone text-green-600 text-2xl"></i>
              </div>
              <h3 class="font-semibold text-gray-800 mb-2">Phone Number</h3>
              <p class="text-sm text-gray-600">
                Search using your registered phone number
              </p>
            </div>

            <div
              class="method-card border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-lg hover:-translate-y-1 text-center"
              data-method="email"
            >
              <div
                class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-envelope text-purple-600 text-2xl"></i>
              </div>
              <h3 class="font-semibold text-gray-800 mb-2">Email Address</h3>
              <p class="text-sm text-gray-600">
                Search using your registered email
              </p>
            </div>
          </div>

          <!-- Search Form -->
          <form id="searchForm" class="space-y-6">
            {% csrf_token %}

            <!-- Booking ID Search -->
            <div id="booking_id_form" class="search-form">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-ticket-alt mr-2 text-blue-500"></i>Booking ID
              </label>
              <input
                type="text"
                name="booking_id"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                placeholder="Enter your booking ID (e.g., TM123456789)"
              />
              <p class="text-xs text-gray-500 mt-1">
                Your booking ID was provided in the confirmation email/SMS
              </p>
            </div>

            <!-- Phone Search -->
            <div id="phone_form" class="search-form hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-phone mr-2 text-green-500"></i>Phone Number
              </label>
              <input
                type="tel"
                name="phone"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                placeholder="Enter your phone number"
              />
              <p class="text-xs text-gray-500 mt-1">
                Enter the phone number used during booking
              </p>
            </div>

            <!-- Email Search -->
            <div id="email_form" class="search-form hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-envelope mr-2 text-purple-500"></i>Email
                Address
              </label>
              <input
                type="email"
                name="email"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200"
                placeholder="Enter your email address"
              />
              <p class="text-xs text-gray-500 mt-1">
                Enter the email address used during booking
              </p>
            </div>

            <!-- Search Button -->
            <button
              type="submit"
              id="searchButton"
              class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-3 rounded-lg hover:from-blue-700 hover:to-indigo-800 transition-all duration-200 transform hover:scale-105 font-medium"
            >
              <i class="fas fa-search mr-2"></i>Search Booking
            </button>
          </form>
        </div>
      </div>

      <!-- Search Results -->
      <div id="searchResults" class="mt-8 hidden">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          <i class="fas fa-list mr-2 text-blue-500"></i>Search Results
        </h3>
        <div id="resultsContainer"></div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="mt-8 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 text-center">
          <div
            class="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"
          ></div>
          <p class="text-gray-600">Searching for your booking...</p>
        </div>
      </div>

      <!-- Help Section -->
      <div class="bg-blue-50 rounded-xl p-6 mt-8 border border-blue-200">
        <h4 class="text-lg font-semibold text-blue-800 mb-3">
          <i class="fas fa-question-circle mr-2"></i>Need Help Finding Your
          Booking?
        </h4>
        <div
          class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700"
        >
          <div>
            <h5 class="font-semibold mb-2">Booking ID Tips:</h5>
            <ul class="space-y-1">
              <li>• Check your confirmation email</li>
              <li>• Look for SMS confirmation</li>
              <li>• Usually starts with "TM" followed by numbers</li>
            </ul>
          </div>
          <div>
            <h5 class="font-semibold mb-2">Contact Information:</h5>
            <ul class="space-y-1">
              <li>• Use the exact phone/email from booking</li>
              <li>• Check for typos in your input</li>
              <li>• Contact support if still having issues</li>
            </ul>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-blue-200">
          <p class="text-sm text-blue-700 mb-3">
            Still can't find your booking? Our support team is here to help:
          </p>
          <div class="flex flex-col sm:flex-row gap-3">
            <a
              href="tel:+977-1-4567890"
              class="text-blue-600 hover:text-blue-700 font-medium text-sm"
            >
              <i class="fas fa-phone mr-2"></i>+977-1-4567890
            </a>
            <a
              href="mailto:support@travelmate.com"
              class="text-blue-600 hover:text-blue-700 font-medium text-sm"
            >
              <i class="fas fa-envelope mr-2"></i>support@travelmate.com
            </a>
            <a
              href="#"
              class="text-blue-600 hover:text-blue-700 font-medium text-sm"
            >
              <i class="fas fa-comments mr-2"></i>Live Chat
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const methodCards = document.querySelectorAll(".method-card");
    const searchForms = document.querySelectorAll(".search-form");
    const searchForm = document.getElementById("searchForm");
    const searchResults = document.getElementById("searchResults");
    const resultsContainer = document.getElementById("resultsContainer");
    const loadingState = document.getElementById("loadingState");
    const searchButton = document.getElementById("searchButton");

    let currentMethod = "booking_id";

    // Method selection
    methodCards.forEach((card) => {
      card.addEventListener("click", function () {
        const method = this.getAttribute("data-method");
        selectMethod(method);
      });
    });

    function selectMethod(method) {
      currentMethod = method;

      // Update card states
      methodCards.forEach((card) => {
        if (card.getAttribute("data-method") === method) {
          card.classList.add("active", "border-blue-500", "bg-blue-50");
          card.classList.remove("border-gray-200");
        } else {
          card.classList.remove("active", "border-blue-500", "bg-blue-50");
          card.classList.add("border-gray-200");
        }
      });

      // Show/hide forms
      searchForms.forEach((form) => {
        if (form.id === method + "_form") {
          form.classList.remove("hidden");
        } else {
          form.classList.add("hidden");
        }
      });

      // Clear previous results
      hideResults();
    }

    // Form submission
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      performSearch();
    });

    function performSearch() {
      const formData = new FormData(searchForm);
      const searchValue = formData.get(currentMethod);

      if (!searchValue || !searchValue.trim()) {
        alert("Please enter a search value.");
        return;
      }

      showLoading();

      // Simulate API call (replace with actual endpoint)
      fetch("/api/search-booking/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          method: currentMethod,
          value: searchValue.trim(),
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          hideLoading();
          if (data.success) {
            displayResults(data.bookings);
          } else {
            displayError(data.message || "No bookings found.");
          }
        })
        .catch((error) => {
          hideLoading();
          displayError("An error occurred while searching. Please try again.");
          console.error("Search error:", error);
        });
    }

    function showLoading() {
      searchButton.disabled = true;
      searchButton.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Searching...';
      loadingState.classList.remove("hidden");
      hideResults();
    }

    function hideLoading() {
      searchButton.disabled = false;
      searchButton.innerHTML =
        '<i class="fas fa-search mr-2"></i>Search Booking';
      loadingState.classList.add("hidden");
    }

    function displayResults(bookings) {
      if (!bookings || bookings.length === 0) {
        displayNoResults();
        return;
      }

      const html = bookings
        .map(
          (booking) => `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4 hover:shadow-xl transition-shadow">
                    <div class="p-6">
                        <!-- Booking Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-ticket-alt mr-2 text-blue-500"></i>${
                                      booking.booking_id
                                    }
                                </h4>
                                <p class="text-sm text-gray-600">Booked on ${formatDate(
                                  booking.created_at
                                )}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                              booking.status === "confirmed"
                                ? "bg-green-100 text-green-800"
                                : booking.status === "pending"
                                ? "bg-yellow-100 text-yellow-800"
                                : booking.status === "cancelled"
                                ? "bg-red-100 text-red-800"
                                : "bg-gray-100 text-gray-800"
                            }">
                                ${
                                  booking.status.charAt(0).toUpperCase() +
                                  booking.status.slice(1)
                                }
                            </span>
                        </div>
                        
                        <!-- Journey Info -->
                        <div class="flex items-center justify-center mb-4">
                            <div class="text-center">
                                <div class="font-semibold text-gray-800">${
                                  booking.source
                                }</div>
                                <div class="text-sm text-gray-500">${
                                  booking.departure_time
                                }</div>
                            </div>
                            <div class="mx-6">
                                <i class="fas fa-arrow-right text-blue-500"></i>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-gray-800">${
                                  booking.destination
                                }</div>
                                <div class="text-sm text-gray-500">${
                                  booking.arrival_time
                                }</div>
                            </div>
                        </div>
                        
                        <!-- Booking Details -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Travel Date</div>
                                <div class="font-semibold">${formatDate(
                                  booking.travel_date
                                )}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Bus Number</div>
                                <div class="font-semibold">${
                                  booking.bus_number
                                }</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Seats</div>
                                <div class="font-semibold">${
                                  booking.seats
                                }</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Total Fare</div>
                                <div class="font-semibold text-green-600">रू${
                                  booking.total_fare
                                }</div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                            <a href="/bookings/${booking.booking_id}/" 
                               class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </a>
                            ${
                              booking.status === "confirmed"
                                ? `
                                <a href="/bookings/ticket/${booking.booking_id}/" 
                                   class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">
                                    <i class="fas fa-ticket-alt mr-1"></i>View Ticket
                                </a>
                                <a href="/bookings/ticket/${booking.booking_id}/download/" 
                                   class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors text-sm">
                                    <i class="fas fa-download mr-1"></i>Download PDF
                                </a>
                            `
                                : ""
                            }
                        </div>
                    </div>
                </div>
            `
        )
        .join("");

      resultsContainer.innerHTML = html;
      searchResults.classList.remove("hidden");
    }

    function displayNoResults() {
      resultsContainer.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-12 text-center">
                    <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Bookings Found</h3>
                    <p class="text-gray-600 mb-6">
                        We couldn't find any bookings matching your search criteria.
                        Please check your details and try again.
                    </p>
                    <button onclick="document.querySelector('input[name=\"${currentMethod}\"]').focus()" 
                            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-search mr-2"></i>Try Another Search
                    </button>
                </div>
            `;
      searchResults.classList.remove("hidden");
    }

    function displayError(message) {
      resultsContainer.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Search Error</h3>
                    <p class="text-red-700">${message}</p>
                </div>
            `;
      searchResults.classList.remove("hidden");
    }

    function hideResults() {
      searchResults.classList.add("hidden");
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Add smooth animations to method cards
    methodCards.forEach((card, index) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(20px)";

      setTimeout(() => {
        card.style.transition = "all 0.5s ease";
        card.style.opacity = "1";
        card.style.transform = "translateY(0)";
      }, index * 100);
    });
  });
</script>
{% endblock %}
