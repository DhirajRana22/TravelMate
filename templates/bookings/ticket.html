{% extends 'base.html' %}
{% load static %}

{% block title %}Ticket - {{ booking.booking_id }} - TravelMate{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-16 -mt-6 print:hidden">
    <div class="container mx-auto px-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-ticket-alt text-2xl"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold mb-2">Bus Ticket</h1>
            <p class="text-xl opacity-90">Your digital travel ticket</p>
        </div>
    </div>
</section>

<!-- Ticket -->
<section class="py-12 bg-gray-50 print:py-0 print:bg-white">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Ticket Card -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border-2 border-gray-200 relative print:shadow-none print:border print:border-black">
                <!-- Ticket Perforations -->
                <div class="absolute top-1/2 -left-3 w-6 h-6 bg-gray-50 rounded-full transform -translate-y-1/2 print:bg-white"></div>
                <div class="absolute top-1/2 -right-3 w-6 h-6 bg-gray-50 rounded-full transform -translate-y-1/2 print:bg-white"></div>
                
                <!-- Ticket Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-8 relative print:bg-blue-600">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <h2 class="text-2xl font-bold mb-2 flex items-center">
                                <i class="fas fa-bus mr-3"></i>TravelMate Bus Ticket
                            </h2>
                            <p class="text-blue-100">Your journey starts here</p>
                        </div>
                        <div class="text-right mt-4 md:mt-0">
                            <div class="text-sm opacity-90 mb-1">Booking ID</div>
                            <div class="text-xl font-bold font-mono cursor-pointer hover:bg-white hover:bg-opacity-10 px-2 py-1 rounded transition-colors" 
                                 id="bookingId" title="Click to copy">{{ booking.booking_id }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Ticket Content -->
                <div class="p-8">
                    <!-- Journey Information -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b border-gray-200 pb-2">
                            <i class="fas fa-route mr-2 text-blue-500"></i>Journey Details
                        </h3>
                        
                        <!-- Route Display -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <div class="flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-800">{{ booking.route.source }}</div>
                                    <div class="text-sm text-gray-500 mt-1">{{ booking.departure_time|time:"g:i A" }}</div>
                                    <div class="text-xs text-gray-400">Departure</div>
                                </div>
                                <div class="mx-8 flex flex-col items-center">
                                    <i class="fas fa-arrow-right text-blue-500 text-2xl mb-2"></i>
                                    <div class="text-xs text-gray-500">{{ booking.journey_duration|default:"N/A" }}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-800">{{ booking.route.destination }}</div>
                                    <div class="text-sm text-gray-500 mt-1">{{ booking.arrival_time|time:"g:i A" }}</div>
                                    <div class="text-xs text-gray-400">Arrival</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Journey Details Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Travel Date</div>
                                <div class="font-semibold text-gray-800">{{ booking.travel_date|date:"l" }}</div>
                                <div class="text-sm text-gray-600">{{ booking.travel_date|date:"M d, Y" }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Bus Number</div>
                                <div class="font-semibold text-gray-800">{{ booking.bus.bus_number }}</div>
                                <div class="text-sm text-gray-600">{{ booking.bus.bus_type }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Seat Numbers</div>
                                <div class="font-semibold text-gray-800">{{ booking.seat_numbers }}</div>
                                <div class="text-sm text-gray-600">{{ booking.passenger_count }} passenger{{ booking.passenger_count|pluralize }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Total Fare</div>
                                <div class="font-semibold text-green-600 text-lg">रू{{ booking.total_fare }}</div>
                                <div class="text-sm text-gray-600">{{ booking.get_status_display }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Passenger Information -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-users mr-2 text-green-500"></i>Passenger Information
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for passenger in booking.passengers.all %}
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 text-sm font-semibold">
                                        {{ forloop.counter }}
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">{{ passenger.name }}</h4>
                                        <p class="text-sm text-gray-600">Seat {{ passenger.seat_number }}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-500">Age:</span>
                                        <span class="font-medium">{{ passenger.age }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Gender:</span>
                                        <span class="font-medium">{{ passenger.gender|title }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Contact & QR Code Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <!-- Contact Information -->
                        <div class="lg:col-span-2">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                                <i class="fas fa-phone mr-2 text-purple-500"></i>Contact Information
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-phone text-green-500 mr-3 text-lg"></i>
                                        <div>
                                            <div class="text-xs text-gray-500">Contact Phone</div>
                                            <div class="font-semibold text-gray-800">{{ booking.contact_phone }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-envelope text-blue-500 mr-3 text-lg"></i>
                                        <div>
                                            <div class="text-xs text-gray-500">Contact Email</div>
                                            <div class="font-semibold text-gray-800">{{ booking.contact_email }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- QR Code -->
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-qrcode mr-2 text-indigo-500"></i>Digital Verification
                            </h3>
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <div id="qrcode" class="flex justify-center mb-3"></div>
                                <p class="text-xs text-gray-600">Scan for quick verification</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Important Information -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
                        <h4 class="text-lg font-semibold text-blue-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Important Travel Information
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
                            <div>
                                <h5 class="font-semibold mb-2">Before Travel:</h5>
                                <ul class="space-y-1">
                                    <li>• Arrive 15 minutes before departure</li>
                                    <li>• Carry valid government ID</li>
                                    <li>• Keep this ticket handy</li>
                                </ul>
                            </div>
                            <div>
                                <h5 class="font-semibold mb-2">During Travel:</h5>
                                <ul class="space-y-1">
                                    <li>• Follow safety instructions</li>
                                    <li>• Keep belongings secure</li>
                                    <li>• Report any issues to driver</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Booking Timeline -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-history mr-2 text-orange-500"></i>Booking Timeline
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-check text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Booking Confirmed</div>
                                    <div class="text-sm text-gray-600">{{ booking.created_at|date:"M d, Y g:i A" }}</div>
                                </div>
                            </div>
                            {% if booking.payment %}
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-credit-card text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Payment Completed</div>
                                    <div class="text-sm text-gray-600">{{ booking.payment.created_at|date:"M d, Y g:i A" }}</div>
                                </div>
                            </div>
                            {% endif %}
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-bus text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">Travel Date</div>
                                    <div class="text-sm text-gray-600">{{ booking.travel_date|date:"M d, Y" }} at {{ booking.departure_time|time:"g:i A" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div class="text-sm text-gray-600 mb-4 md:mb-0">
                                <p>Thank you for choosing TravelMate!</p>
                                <p>For support: +977-1-4567890 | support@travelmate.com</p>
                            </div>
                            <div class="text-sm text-gray-500">
                                <p>Ticket generated on {{ booking.created_at|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8 print:hidden">
                <button onclick="window.print()" 
                        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    <i class="fas fa-print mr-2"></i>Print Ticket
                </button>
                
                <button onclick="downloadTicket()" 
                        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                    <i class="fas fa-download mr-2"></i>Download PDF
                </button>
                
                <a href="{% url 'bookings:booking_detail' booking.booking_id %}" 
                   class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors font-medium text-center">
                    <i class="fas fa-eye mr-2"></i>View Details
                </a>
                
                {% if booking.status == 'confirmed' and booking.can_cancel %}
                    <a href="{% url 'bookings:cancel_booking' booking.booking_id %}" 
                       class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-medium text-center">
                        <i class="fas fa-times mr-2"></i>Cancel Booking
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
@media print {
    body {
        background: white !important;
    }
    
    .print\:hidden {
        display: none !important;
    }
    
    .print\:py-0 {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }
    
    .print\:bg-white {
        background: white !important;
    }
    
    .print\:shadow-none {
        box-shadow: none !important;
    }
    
    .print\:border {
        border: 1px solid black !important;
    }
    
    .print\:border-black {
        border-color: black !important;
    }
    
    .print\:bg-blue-600 {
        background: #2563eb !important;
        -webkit-print-color-adjust: exact;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Generate QR Code
        const qrData = JSON.stringify({
            bookingId: '{{ booking.booking_id }}',
            passengerName: '{{ booking.passengers.first.name }}',
            route: '{{ booking.route.source }} to {{ booking.route.destination }}',
            date: '{{ booking.travel_date|date:"Y-m-d" }}',
            seats: '{{ booking.seat_numbers }}',
            status: '{{ booking.status }}'
        });
        
        QRCode.toCanvas(document.getElementById('qrcode'), qrData, {
            width: 150,
            height: 150,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        }, function (error) {
            if (error) {
                console.error('QR Code generation error:', error);
                document.getElementById('qrcode').innerHTML = '<i class="fas fa-qrcode text-4xl text-gray-400"></i>';
            }
        });
        
        // Auto-print functionality (optional)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('print') === 'true') {
            setTimeout(() => {
                window.print();
            }, 1000);
        }
        
        // Copy booking ID functionality
        const bookingIdElement = document.getElementById('bookingId');
        if (bookingIdElement) {
            bookingIdElement.addEventListener('click', function() {
                const bookingId = '{{ booking.booking_id }}';
                navigator.clipboard.writeText(bookingId).then(() => {
                    // Show temporary feedback
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    this.classList.add('bg-green-500');
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('bg-green-500');
                    }, 1000);
                }).catch(() => {
                    // Fallback for browsers that don't support clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = bookingId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    this.classList.add('bg-green-500');
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('bg-green-500');
                    }, 1000);
                });
            });
        }
        
        // Responsive QR code size
        function adjustQRSize() {
            const qrCodeElement = document.getElementById('qrcode');
            if (qrCodeElement && window.innerWidth < 480) {
                // Regenerate QR code with smaller size for mobile
                QRCode.toCanvas(qrCodeElement, qrData, {
                    width: 120,
                    height: 120,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });
            }
        }
        
        adjustQRSize();
        window.addEventListener('resize', adjustQRSize);
    });
    
    function downloadTicket() {
        // Create a new window with the ticket content
        const printWindow = window.open('', '_blank');
        const ticketContent = document.querySelector('.max-w-4xl').outerHTML;
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>TravelMate - Bus Ticket</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                    .print\\:hidden { display: none; }
                    @media print {
                        body { margin: 0; }
                        .max-w-4xl { max-width: none; }
                    }
                </style>
            </head>
            <body>
                <div class="container mx-auto">
                    <h2 class="text-center mb-4 text-2xl font-bold">TravelMate - Bus Ticket</h2>
                    ${ticketContent}
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load then trigger download
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }
</script>
{% endblock %}