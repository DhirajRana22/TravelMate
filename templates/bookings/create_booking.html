{% extends 'base.html' %} {% load static %} {% block title %}Create Booking -
TravelMate{% endblock %} {% block content %}
<!-- Header -->
<section
  class="bg-gradient-to-r from-green-600 to-emerald-700 text-white py-16 -mt-6"
>
  <div class="container mx-auto px-4">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Create Booking</h1>
      <p class="text-xl opacity-90">Complete your bus ticket reservation</p>
    </div>
  </div>
</section>

<!-- Booking Process -->
<section class="py-8 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Progress Steps -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div
              class="flex items-center justify-center w-10 h-10 bg-blue-500 text-white rounded-full font-semibold"
            >
              <i class="fas fa-check"></i>
            </div>
            <span class="text-sm font-medium text-blue-600"
              >Route Selected</span
            >
          </div>

          <div class="flex-1 h-1 bg-gray-200 mx-4">
            <div class="h-1 bg-blue-500 w-1/3"></div>
          </div>

          <div class="flex items-center space-x-4">
            <div
              class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-full font-semibold"
            >
              2
            </div>
            <span class="text-sm font-medium text-green-600"
              >Passenger Details</span
            >
          </div>

          <div class="flex-1 h-1 bg-gray-200 mx-4">
            <div class="h-1 bg-gray-200 w-0"></div>
          </div>

          <div class="flex items-center space-x-4">
            <div
              class="flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-600 rounded-full font-semibold"
            >
              3
            </div>
            <span class="text-sm font-medium text-gray-500">Payment</span>
          </div>
        </div>
      </div>

      <!-- Journey Summary -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3
          class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2"
        >
          <i class="fas fa-route mr-2 text-blue-500"></i>Journey Summary
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-map-marker-alt text-blue-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">From</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.route.source }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-map-marker-alt text-green-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">To</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.route.destination }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-calendar text-purple-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Date</p>
              <p class="font-semibold text-gray-800">
                {{ travel_date|date:"M d, Y" }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-clock text-orange-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Departure</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.departure_time|time:"g:i A" }}
              </p>
            </div>
          </div>
        </div>

        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-600">
                Bus:
                <span class="font-semibold">{{ schedule.bus.bus_number }}</span>
              </p>
              <p class="text-sm text-gray-600">
                Type:
                <span class="font-semibold">{{ schedule.bus.bus_type }}</span>
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">
                Selected Seats:
                <span class="font-semibold"
                  >{{ selected_seats|join:", " }}</span
                >
              </p>
              <p class="text-lg font-bold text-green-600">
                Total: रू{{ total_fare }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Passenger Details Form -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-users mr-2 text-green-500"></i>Passenger Details
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            Please provide accurate information for all passengers
          </p>
        </div>

        <div class="p-6">
          <form method="post" id="bookingForm" class="space-y-8">
            {% csrf_token %}

            <!-- Hidden fields -->
            <input type="hidden" name="schedule_id" value="{{ schedule.id }}" />
            <input type="hidden" name="travel_date" value="{{ travel_date }}" />
            <input
              type="hidden"
              name="selected_seats"
              value="{{ selected_seats|join:',' }}"
            />

            <!-- Passenger Information -->
            {% for seat in selected_seats %}
            <div
              class="passenger-section border border-gray-200 rounded-lg p-6"
            >
              <h4
                class="text-lg font-semibold text-gray-800 mb-4 flex items-center"
              >
                <div
                  class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 text-sm font-bold"
                >
                  {{ forloop.counter }}
                </div>
                Passenger {{ forloop.counter }} - Seat {{ seat }}
              </h4>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Full Name <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="passenger_{{ forloop.counter0 }}_name"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Enter full name"
                    required
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-passenger-{{ forloop.counter0 }}-name"
                  ></div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Age <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="number"
                    name="passenger_{{ forloop.counter0 }}_age"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Enter age"
                    min="1"
                    max="120"
                    required
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-passenger-{{ forloop.counter0 }}-age"
                  ></div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Gender <span class="text-red-500">*</span>
                  </label>
                  <select
                    name="passenger_{{ forloop.counter0 }}_gender"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    required
                  >
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                  </select>
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-passenger-{{ forloop.counter0 }}-gender"
                  ></div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Phone Number {% if forloop.first %}<span
                      class="text-red-500"
                      >*</span
                    >{% endif %}
                  </label>
                  <input
                    type="tel"
                    name="passenger_{{ forloop.counter0 }}_phone"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Enter phone number"
                    {%
                    if
                    forloop.first
                    %}required{%
                    endif
                    %}
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-passenger-{{ forloop.counter0 }}-phone"
                  ></div>
                </div>

                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Email Address {% if forloop.first %}<span
                      class="text-red-500"
                      >*</span
                    >{% endif %}
                  </label>
                  <input
                    type="email"
                    name="passenger_{{ forloop.counter0 }}_email"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Enter email address"
                    {%
                    if
                    forloop.first
                    %}required{%
                    endif
                    %}
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-passenger-{{ forloop.counter0 }}-email"
                  ></div>
                </div>
              </div>
            </div>
            {% endfor %}

            <!-- Contact Information -->
            <div class="border border-gray-200 rounded-lg p-6">
              <h4
                class="text-lg font-semibold text-gray-800 mb-4 flex items-center"
              >
                <i class="fas fa-phone mr-3 text-green-500"></i>
                Contact Information
              </h4>
              <p class="text-sm text-gray-600 mb-4">
                This information will be used for booking confirmations and
                updates
              </p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Contact Phone <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="tel"
                    name="contact_phone"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Primary contact number"
                    required
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-contact-phone"
                  ></div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Contact Email <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="email"
                    name="contact_email"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Primary email address"
                    required
                  />
                  <div
                    class="error-message text-red-600 text-sm mt-1 hidden"
                    id="error-contact-email"
                  ></div>
                </div>
              </div>
            </div>

            <!-- Special Requirements -->
            <div class="border border-gray-200 rounded-lg p-6">
              <h4
                class="text-lg font-semibold text-gray-800 mb-4 flex items-center"
              >
                <i class="fas fa-clipboard-list mr-3 text-purple-500"></i>
                Special Requirements (Optional)
              </h4>

              <div class="space-y-4">
                <div>
                  <label class="flex items-center">
                    <input
                      type="checkbox"
                      name="wheelchair_accessible"
                      class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                    />
                    <span class="ml-2 text-sm text-gray-700"
                      >Wheelchair accessible seating required</span
                    >
                  </label>
                </div>

                <div>
                  <label class="flex items-center">
                    <input
                      type="checkbox"
                      name="meal_preference"
                      class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                    />
                    <span class="ml-2 text-sm text-gray-700"
                      >Special meal requirements</span
                    >
                  </label>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Additional Notes
                  </label>
                  <textarea
                    name="special_notes"
                    rows="3"
                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200"
                    placeholder="Any special requirements or notes..."
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="border border-gray-200 rounded-lg p-6">
              <div class="flex items-start">
                <input
                  type="checkbox"
                  id="terms_accepted"
                  name="terms_accepted"
                  class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-1"
                  required
                />
                <label
                  for="terms_accepted"
                  class="ml-2 block text-sm text-gray-700"
                >
                  I agree to the
                  <a
                    href="#"
                    class="text-green-600 hover:text-green-500 font-medium"
                    >Terms and Conditions</a
                  >
                  and
                  <a
                    href="#"
                    class="text-green-600 hover:text-green-500 font-medium"
                    >Cancellation Policy</a
                  >
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4">
              <a
                href="{% url 'bookings:seat_selection' schedule.id %}?date={{ travel_date }}"
                class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-colors text-center font-medium"
              >
                <i class="fas fa-arrow-left mr-2"></i>Back to Seat Selection
              </a>

              <button
                type="submit"
                id="continueBtn"
                class="bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-3 rounded-lg hover:from-green-700 hover:to-emerald-800 transition-all duration-200 transform hover:scale-105 font-medium"
              >
                <i class="fas fa-credit-card mr-2"></i>Continue to Payment
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("bookingForm");
    const continueBtn = document.getElementById("continueBtn");
    const requiredFields = form.querySelectorAll(
      "input[required], select[required]"
    );

    // Validation functions
    function showError(field, message) {
      field.classList.add("border-red-500", "ring-red-500");
      field.classList.remove("border-gray-300");

      const errorId = "error-" + field.name.replace(/_/g, "-");
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
      }
    }

    function clearError(field) {
      field.classList.remove("border-red-500", "ring-red-500");
      field.classList.add("border-gray-300");

      const errorId = "error-" + field.name.replace(/_/g, "-");
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.textContent = "";
        errorElement.classList.add("hidden");
      }
    }

    function validateForm() {
      let isValid = true;

      requiredFields.forEach((field) => {
        if (!field.value.trim()) {
          showError(field, "This field is required");
          isValid = false;
        } else {
          clearError(field);

          // Additional validation
          if (field.type === "email" && !isValidEmail(field.value)) {
            showError(field, "Please enter a valid email address");
            isValid = false;
          } else if (field.type === "tel" && !isValidPhone(field.value)) {
            showError(field, "Please enter a valid phone number");
            isValid = false;
          } else if (field.type === "number") {
            const age = parseInt(field.value);
            if (age < 1 || age > 120) {
              showError(field, "Please enter a valid age (1-120)");
              isValid = false;
            }
          }
        }
      });

      // Check terms acceptance
      const termsCheckbox = document.getElementById("terms_accepted");
      if (!termsCheckbox.checked) {
        alert("Please accept the terms and conditions to continue.");
        isValid = false;
      }

      return isValid;
    }

    function isValidPhone(phone) {
      const phoneRegex = /^[+]?[0-9]{10,15}$/;
      return phoneRegex.test(phone.replace(/\s/g, ""));
    }

    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Real-time validation
    requiredFields.forEach((field) => {
      field.addEventListener("blur", function () {
        if (!this.value.trim()) {
          showError(this, "This field is required");
        } else {
          clearError(this);
        }
      });

      field.addEventListener("input", function () {
        if (this.classList.contains("border-red-500") && this.value.trim()) {
          clearError(this);
        }
      });
    });

    // Phone number formatting
    const phoneInputs = form.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach((input) => {
      input.addEventListener("input", function () {
        // Remove non-numeric characters except +
        this.value = this.value.replace(/[^+0-9]/g, "");
      });
    });

    // Auto-fill contact info from first passenger
    const firstPassengerPhone = form.querySelector(
      'input[name="passenger_0_phone"]'
    );
    const firstPassengerEmail = form.querySelector(
      'input[name="passenger_0_email"]'
    );
    const contactPhone = form.querySelector('input[name="contact_phone"]');
    const contactEmail = form.querySelector('input[name="contact_email"]');

    if (firstPassengerPhone && contactPhone) {
      firstPassengerPhone.addEventListener("blur", function () {
        if (this.value && !contactPhone.value) {
          contactPhone.value = this.value;
        }
      });
    }

    if (firstPassengerEmail && contactEmail) {
      firstPassengerEmail.addEventListener("blur", function () {
        if (this.value && !contactEmail.value) {
          contactEmail.value = this.value;
        }
      });
    }

    // Form submission
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      if (!validateForm()) {
        // Scroll to first error
        const firstError = document.querySelector(".border-red-500");
        if (firstError) {
          firstError.scrollIntoView({ behavior: "smooth", block: "center" });
          firstError.focus();
        }
        return;
      }

      // Show loading state
      continueBtn.disabled = true;
      continueBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

      // Submit form
      this.submit();
    });

    // Add smooth animations to passenger sections
    const passengerSections = document.querySelectorAll(".passenger-section");
    passengerSections.forEach((section, index) => {
      section.style.opacity = "0";
      section.style.transform = "translateY(20px)";

      setTimeout(() => {
        section.style.transition = "all 0.5s ease";
        section.style.opacity = "1";
        section.style.transform = "translateY(0)";
      }, index * 200);
    });
  });
</script>
{% endblock %}
