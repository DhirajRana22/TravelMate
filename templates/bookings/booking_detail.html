{% extends 'base.html' %}
{% load static %}

{% block title %}Booking Details - {{ booking.booking_id }} - TravelMate{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-to-r from-blue-600 to-purple-700 text-white py-16 -mt-6">
    <div class="container mx-auto px-4">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-4">Booking Details</h1>
            <div class="bg-white bg-opacity-20 rounded-lg p-4 inline-block mb-4">
                <p class="text-sm opacity-90 mb-1">Booking Reference</p>
                <p class="text-2xl font-bold cursor-pointer hover:bg-white hover:bg-opacity-10 px-3 py-1 rounded transition-colors" 
                   id="bookingId" title="Click to copy booking ID">{{ booking.booking_id }}</p>
            </div>
            <div class="mt-4">
                <span class="px-4 py-2 rounded-full font-semibold text-sm uppercase tracking-wide
                    {% if booking.status == 'confirmed' %}bg-green-500 text-white
                    {% elif booking.status == 'pending' %}bg-yellow-500 text-white
                    {% elif booking.status == 'cancelled' %}bg-red-500 text-white
                    {% else %}bg-gray-500 text-white{% endif %}">
                    {{ booking.get_status_display }}
                </span>
            </div>
        </div>
    </div>
</section>

<!-- Booking Details -->
<section class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Details -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Journey Information -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6">
                            <h3 class="text-xl font-semibold mb-4">Journey Information</h3>
                            <div class="flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-2xl font-bold">{{ booking.route.source }}</div>
                                    <div class="text-sm opacity-90">{{ booking.departure_time|time:"g:i A" }}</div>
                                </div>
                                <div class="mx-8">
                                    <i class="fas fa-arrow-right text-2xl"></i>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">{{ booking.route.destination }}</div>
                                    <div class="text-sm opacity-90">{{ booking.arrival_time|time:"g:i A" }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-calendar mr-2 text-blue-500"></i>Travel Date
                                        </span>
                                        <span class="font-semibold">{{ booking.travel_date|date:"M d, Y" }}</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-bus mr-2 text-green-500"></i>Bus Number
                                        </span>
                                        <span class="font-semibold">{{ booking.bus.bus_number }}</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-cog mr-2 text-purple-500"></i>Bus Type
                                        </span>
                                        <span class="font-semibold">{{ booking.bus.bus_type }}</span>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-chair mr-2 text-orange-500"></i>Seats
                                        </span>
                                        <span class="font-semibold">{{ booking.seat_numbers }}</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-users mr-2 text-indigo-500"></i>Passengers
                                        </span>
                                        <span class="font-semibold">{{ booking.passenger_count }}</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                        <span class="flex items-center text-gray-600">
                                            <i class="fas fa-clock mr-2 text-red-500"></i>Duration
                                        </span>
                                        <span class="font-semibold">{{ booking.journey_duration|default:"N/A" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Passenger Details -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-users mr-2 text-blue-500"></i>Passenger Details
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% for passenger in booking.passengers.all %}
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-3">
                                        <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 font-semibold">
                                            {{ forloop.counter }}
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">{{ passenger.name }}</h4>
                                            <p class="text-sm text-gray-600">Seat {{ passenger.seat_number }}</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-500">Age:</span>
                                            <span class="font-medium">{{ passenger.age }}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Gender:</span>
                                            <span class="font-medium">{{ passenger.gender|title }}</span>
                                        </div>
                                        {% if passenger.phone %}
                                        <div class="col-span-2">
                                            <span class="text-gray-500">Phone:</span>
                                            <span class="font-medium">{{ passenger.phone }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-phone mr-2 text-green-500"></i>Contact Information
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center">
                                    <i class="fas fa-phone text-green-500 mr-3 text-xl"></i>
                                    <div>
                                        <div class="text-sm text-gray-500">Contact Phone</div>
                                        <div class="font-semibold text-lg">{{ booking.contact_phone }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-envelope text-blue-500 mr-3 text-xl"></i>
                                    <div>
                                        <div class="text-sm text-gray-500">Contact Email</div>
                                        <div class="font-semibold text-lg">{{ booking.contact_email }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Booking Timeline -->
                    {% if booking.timeline %}
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-history mr-2 text-purple-500"></i>Booking Timeline
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="space-y-4">
                                {% for event in booking.timeline %}
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-4">
                                        <i class="fas fa-{{ event.icon|default:'circle' }} text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">{{ event.title }}</h4>
                                        <p class="text-gray-600 text-sm">{{ event.description }}</p>
                                        <p class="text-xs text-gray-500 mt-1">{{ event.timestamp|date:"M d, Y g:i A" }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- QR Code -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-qrcode mr-2 text-indigo-500"></i>Digital Ticket
                            </h3>
                        </div>
                        
                        <div class="p-6 text-center">
                            <div id="qrcode" class="mb-4 flex justify-center"></div>
                            <p class="text-sm text-gray-600">Scan this QR code for quick verification</p>
                        </div>
                    </div>
                    
                    <!-- Fare Breakdown -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-receipt mr-2 text-green-500"></i>Fare Breakdown
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Base Fare ({{ booking.passenger_count }} passenger{{ booking.passenger_count|pluralize }}):</span>
                                    <span class="font-semibold">रू{{ booking.base_fare }}</span>
                                </div>
                                {% if booking.service_charge %}
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Service Charge:</span>
                                    <span class="font-semibold">रू{{ booking.service_charge }}</span>
                                </div>
                                {% endif %}
                                {% if booking.discount_amount %}
                                <div class="flex justify-between text-green-600">
                                    <span>Discount:</span>
                                    <span class="font-semibold">-रू{{ booking.discount_amount }}</span>
                                </div>
                                {% endif %}
                                <hr class="border-gray-300">
                                <div class="flex justify-between text-lg font-bold text-gray-800">
                                    <span>Total Fare:</span>
                                    <span class="text-green-600">रू{{ booking.total_fare }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    {% if booking.payment %}
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-credit-card mr-2 text-purple-500"></i>Payment Details
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Method:</span>
                                    <span class="font-semibold">{{ booking.payment.payment_method|title }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Status:</span>
                                    <span class="font-semibold text-green-600">{{ booking.payment.status|title }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Transaction ID:</span>
                                    <span class="font-semibold font-mono text-sm">{{ booking.payment.transaction_id }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Payment Date:</span>
                                    <span class="font-semibold">{{ booking.payment.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons space-y-3">
                        <button onclick="printTicket()" 
                                class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                            <i class="fas fa-print mr-2"></i>Print Ticket
                        </button>
                        
                        <button onclick="downloadTicket()" 
                                class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                            <i class="fas fa-download mr-2"></i>Download PDF
                        </button>
                        
                        {% if booking.status == 'confirmed' and booking.can_cancel %}
                        <a href="{% url 'bookings:cancel_booking' booking.booking_id %}" 
                           class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition-colors font-medium text-center block">
                            <i class="fas fa-times mr-2"></i>Cancel Booking
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'accounts:booking_history' %}" 
                           class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium text-center block">
                            <i class="fas fa-list mr-2"></i>All Bookings
                        </a>
                    </div>
                    
                    <!-- Support -->
                    <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">
                            <i class="fas fa-headset mr-2"></i>Need Help?
                        </h4>
                        <p class="text-sm text-blue-700 mb-4">Contact our support team for assistance</p>
                        <div class="space-y-2">
                            <a href="tel:+977-1-4567890" class="block text-blue-600 hover:text-blue-700 font-medium text-sm">
                                <i class="fas fa-phone mr-2"></i>+977-1-4567890
                            </a>
                            <a href="mailto:support@travelmate.com" class="block text-blue-600 hover:text-blue-700 font-medium text-sm">
                                <i class="fas fa-envelope mr-2"></i>support@travelmate.com
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
@media print {
    .action-buttons {
        display: none !important;
    }
    
    body {
        background: white !important;
    }
    
    .bg-gray-50 {
        background: white !important;
    }
    
    .bg-gradient-to-r {
        background: #667eea !important;
        -webkit-print-color-adjust: exact;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Generate QR Code
        const qrData = JSON.stringify({
            bookingId: '{{ booking.booking_id }}',
            passengerName: '{{ booking.passengers.first.name }}',
            route: '{{ booking.route.source }} to {{ booking.route.destination }}',
            date: '{{ booking.travel_date|date:"Y-m-d" }}',
            seats: '{{ booking.seat_numbers }}'
        });
        
        QRCode.toCanvas(document.getElementById('qrcode'), qrData, {
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        }, function (error) {
            if (error) console.error(error);
        });
        
        // Copy booking ID functionality
        const bookingIdElement = document.getElementById('bookingId');
        if (bookingIdElement) {
            bookingIdElement.addEventListener('click', function() {
                const bookingId = '{{ booking.booking_id }}';
                navigator.clipboard.writeText(bookingId).then(function() {
                    showToast('Booking ID copied to clipboard!', 'success');
                }).catch(function() {
                    // Fallback for browsers that don't support clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = bookingId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Booking ID copied to clipboard!', 'success');
                });
            });
        }
        
        // Add smooth animations to cards
        const cards = document.querySelectorAll('.bg-white');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
    
    function printTicket() {
        window.print();
    }
    
    function downloadTicket() {
        // Create a new window with the ticket content
        const printWindow = window.open('', '_blank');
        const ticketContent = document.querySelector('.container').outerHTML;
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>TravelMate - Booking Details</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                    .action-buttons { display: none; }
                    @media print {
                        body { margin: 0; }
                    }
                </style>
            </head>
            <body>
                <div class="container mx-auto">
                    <h2 class="text-center mb-4 text-2xl font-bold">TravelMate - Booking Details</h2>
                    ${ticketContent}
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load then trigger download
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
        } min-w-80`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle mr-2"></i>
                ${message}
                <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }
</script>
{% endblock %}