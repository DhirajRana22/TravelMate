{% extends 'base.html' %}
{% load static %}

{% block title %}Booking Confirmation - TravelMate{% endblock %}

{% block content %}
<!-- Success Header -->
<section class="bg-gradient-to-r from-green-600 to-emerald-700 text-white py-20 -mt-6">
    <div class="container mx-auto px-4 text-center">
        <div class="success-icon text-6xl mb-6 animate-bounce">
            <i class="fas fa-check-circle"></i>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Booking Confirmed!</h1>
        <p class="text-xl opacity-90 mb-6">Your bus ticket has been successfully booked</p>
        <div class="bg-white bg-opacity-20 rounded-lg p-4 inline-block">
            <p class="text-sm opacity-90 mb-1">Booking Reference</p>
            <p class="text-2xl font-bold booking-id cursor-pointer hover:bg-white hover:bg-opacity-10 px-3 py-1 rounded transition-colors" 
               title="Click to copy booking ID">{{ booking.booking_id }}</p>
        </div>
    </div>
</section>

<!-- Booking Details -->
<section class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Main Booking Card -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-8 booking-card">
                <!-- Booking Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6 text-center">
                    <h2 class="text-2xl font-bold mb-2">TravelMate Bus Ticket</h2>
                    <div class="bg-white bg-opacity-20 rounded-full px-4 py-2 inline-block">
                        <span class="text-sm font-semibold">{{ booking.get_status_display }}</span>
                    </div>
                </div>
                
                <!-- Journey Information -->
                <div class="p-8">
                    <!-- Route Display -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-8">
                        <div class="flex items-center justify-center mb-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800">{{ booking.route.source }}</div>
                                <div class="text-sm text-gray-500">{{ booking.departure_time|time:"g:i A" }}</div>
                            </div>
                            <div class="mx-8 text-blue-500">
                                <i class="fas fa-arrow-right text-3xl"></i>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-800">{{ booking.route.destination }}</div>
                                <div class="text-sm text-gray-500">{{ booking.arrival_time|time:"g:i A" }}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                                <div class="text-xs text-gray-500 mb-1">Travel Date</div>
                                <div class="font-semibold text-gray-800">{{ booking.travel_date|date:"M d, Y" }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                                <div class="text-xs text-gray-500 mb-1">Bus Number</div>
                                <div class="font-semibold text-gray-800">{{ booking.bus.bus_number }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                                <div class="text-xs text-gray-500 mb-1">Bus Type</div>
                                <div class="font-semibold text-gray-800">{{ booking.bus.bus_type }}</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                                <div class="text-xs text-gray-500 mb-1">Operator</div>
                                <div class="font-semibold text-gray-800">{{ booking.bus.operator|default:"TravelMate" }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Passenger Details -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-users mr-2 text-blue-500"></i>Passenger Details
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% for passenger in booking.passengers.all %}
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="flex items-center mb-3">
                                    <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 font-semibold">
                                        {{ forloop.counter }}
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">{{ passenger.name }}</h4>
                                        <p class="text-sm text-gray-600">Seat {{ passenger.seat_number }}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-500">Age:</span>
                                        <span class="font-medium">{{ passenger.age }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Gender:</span>
                                        <span class="font-medium">{{ passenger.gender|title }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-phone mr-2 text-green-500"></i>Contact Information
                        </h3>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex items-center">
                                    <i class="fas fa-phone text-green-500 mr-3"></i>
                                    <div>
                                        <div class="text-xs text-gray-500">Contact Phone</div>
                                        <div class="font-semibold">{{ booking.contact_phone }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-envelope text-blue-500 mr-3"></i>
                                    <div>
                                        <div class="text-xs text-gray-500">Contact Email</div>
                                        <div class="font-semibold">{{ booking.contact_email }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fare Breakdown -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-receipt mr-2 text-purple-500"></i>Fare Breakdown
                        </h3>
                        
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Base Fare ({{ booking.passenger_count }} passenger{{ booking.passenger_count|pluralize }}):</span>
                                    <span class="font-semibold">रू{{ booking.base_fare }}</span>
                                </div>
                                {% if booking.service_charge %}
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Service Charge:</span>
                                    <span class="font-semibold">रू{{ booking.service_charge }}</span>
                                </div>
                                {% endif %}
                                {% if booking.discount_amount %}
                                <div class="flex justify-between text-green-600">
                                    <span>Discount:</span>
                                    <span class="font-semibold">-रू{{ booking.discount_amount }}</span>
                                </div>
                                {% endif %}
                                <hr class="border-gray-300">
                                <div class="flex justify-between text-lg font-bold text-gray-800">
                                    <span>Total Fare:</span>
                                    <span class="text-green-600">रू{{ booking.total_fare }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    {% if payment %}
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                            <i class="fas fa-credit-card mr-2 text-indigo-500"></i>Payment Information
                        </h3>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex items-center">
                                    <i class="fas fa-money-check-alt text-indigo-500 mr-3"></i>
                                    <div>
                                        <div class="text-xs text-gray-500">Payment Method</div>
                                        <div class="font-semibold">{{ payment.payment_method|title }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                    <div>
                                        <div class="text-xs text-gray-500">Payment Status</div>
                                        <div class="font-semibold text-green-600">{{ payment.payment_status|title }}</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-hashtag text-gray-500 mr-3"></i>
                                    <div>
                                        <div class="text-xs text-gray-500">Transaction ID</div>
                                        <div class="font-semibold font-mono text-sm">{{ payment.transaction_id }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Important Information -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3">
                            <i class="fas fa-info-circle mr-2"></i>Important Information
                        </h4>
                        <ul class="text-sm text-blue-700 space-y-2">
                            <li class="flex items-start">
                                <i class="fas fa-clock mr-2 mt-0.5 text-blue-600"></i>
                                <span>Please arrive at the departure point at least 15 minutes before departure time</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-id-card mr-2 mt-0.5 text-blue-600"></i>
                                <span>Carry a valid government-issued photo ID for verification</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-mobile-alt mr-2 mt-0.5 text-blue-600"></i>
                                <span>Keep this booking confirmation handy (digital or printed copy)</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-ban mr-2 mt-0.5 text-blue-600"></i>
                                <span>Cancellation charges may apply as per our cancellation policy</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons flex flex-col sm:flex-row gap-4 justify-center mb-8">
                <button onclick="printTicket()" 
                        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    <i class="fas fa-print mr-2"></i>Print Ticket
                </button>
                
                <button onclick="downloadTicket()" 
                        class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-medium">
                    <i class="fas fa-download mr-2"></i>Download PDF
                </button>
                
                <a href="{% url 'accounts:booking_history' %}" 
                   class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors font-medium text-center">
                    <i class="fas fa-history mr-2"></i>View All Bookings
                </a>
                
                <a href="{% url 'routes:route_search' %}" 
                   class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors font-medium text-center">
                    <i class="fas fa-search mr-2"></i>Book Another Trip
                </a>
            </div>
            
            <!-- Support Information -->
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-headset mr-2 text-green-500"></i>Need Help?
                </h3>
                <p class="text-gray-600 mb-4">Our customer support team is here to assist you 24/7</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="tel:+977-1-4567890" class="text-green-600 hover:text-green-700 font-medium">
                        <i class="fas fa-phone mr-2"></i>+977-1-4567890
                    </a>
                    <a href="mailto:support@travelmate.com" class="text-blue-600 hover:text-blue-700 font-medium">
                        <i class="fas fa-envelope mr-2"></i>support@travelmate.com
                    </a>
                    <a href="#" class="text-purple-600 hover:text-purple-700 font-medium">
                        <i class="fas fa-comments mr-2"></i>Live Chat
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-20px);
    }
    60% {
        transform: translateY(-10px);
    }
}

.animate-bounce {
    animation: bounce 2s infinite;
}

@media print {
    .action-buttons {
        display: none !important;
    }
    
    body {
        background: white !important;
    }
    
    .bg-gray-50 {
        background: white !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    function printTicket() {
        window.print();
    }
    
    function downloadTicket() {
        // Create a new window with the ticket content
        const printWindow = window.open('', '_blank');
        const ticketContent = document.querySelector('.booking-card').outerHTML;
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>TravelMate - Booking Confirmation</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                    .booking-card { border: 2px solid #000; }
                    .action-buttons { display: none; }
                    @media print {
                        body { margin: 0; }
                        .booking-card { border: 1px solid #000; }
                    }
                </style>
            </head>
            <body>
                <div class="container mx-auto">
                    <h2 class="text-center mb-4 text-2xl font-bold">TravelMate - Bus Ticket</h2>
                    ${ticketContent}
                </div>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load then trigger download
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
    }
    
    // Auto-focus on page load for better accessibility
    document.addEventListener('DOMContentLoaded', function() {
        // Add success animation
        const successIcon = document.querySelector('.success-icon');
        if (successIcon) {
            setTimeout(() => {
                successIcon.classList.add('animate-bounce');
            }, 500);
        }
        
        // Add copy booking ID functionality
        const bookingId = document.querySelector('.booking-id');
        if (bookingId) {
            bookingId.addEventListener('click', function() {
                const id = this.textContent.trim();
                navigator.clipboard.writeText(id).then(() => {
                    // Show temporary success message
                    const originalText = this.textContent;
                    this.textContent = 'Booking ID Copied!';
                    this.classList.add('bg-green-500');
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('bg-green-500');
                    }, 2000);
                }).catch(() => {
                    // Fallback for browsers that don't support clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = id;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    const originalText = this.textContent;
                    this.textContent = 'Booking ID Copied!';
                    this.classList.add('bg-green-500');
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('bg-green-500');
                    }, 2000);
                });
            });
        }
        
        // Add smooth animations to cards
        const cards = document.querySelectorAll('.bg-white');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 200);
        });
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'p':
                    e.preventDefault();
                    printTicket();
                    break;
                case 'd':
                    e.preventDefault();
                    downloadTicket();
                    break;
            }
        }
    });
</script>
{% endblock %}