{% extends 'base.html' %} {% load static %} {% block title %}Select Seats -
TravelMate{% endblock %} {% block content %}
<!-- Header -->
<section
  class="bg-gradient-to-r from-blue-600 to-purple-700 text-white py-16 -mt-6"
>
  <div class="container mx-auto px-4">
    <div class="text-center">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Select Your Seats</h1>
      <p class="text-xl opacity-90">
        Choose your preferred seats for a comfortable journey
      </p>
    </div>
  </div>
</section>

<!-- Seat Selection -->
<section class="py-8 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="max-w-6xl mx-auto">
      <!-- Journey Information -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3
          class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2"
        >
          <i class="fas fa-route mr-2 text-blue-500"></i>Journey Details
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-map-marker-alt text-blue-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">From</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.route.source }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-map-marker-alt text-green-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">To</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.route.destination }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-calendar text-purple-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Date</p>
              <p class="font-semibold text-gray-800">
                {{ travel_date|date:"M d, Y" }}
              </p>
            </div>
          </div>

          <div class="flex items-center">
            <div
              class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-3"
            >
              <i class="fas fa-clock text-orange-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500">Departure</p>
              <p class="font-semibold text-gray-800">
                {{ schedule.departure_time|time:"g:i A" }}
              </p>
            </div>
          </div>
        </div>

        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-600">
                Bus:
                <span class="font-semibold">{{ schedule.bus.bus_number }}</span>
              </p>
              <p class="text-sm text-gray-600">
                Type:
                <span class="font-semibold">{{ schedule.bus.bus_type }}</span>
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">
                Base Fare:
                <span class="font-semibold">रू{{ schedule.base_fare }}</span>
              </p>
              <p class="text-sm text-gray-600">
                Available Seats:
                <span class="font-semibold">{{ available_seats_count }}</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Seat Map -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-chair mr-2 text-purple-500"></i>Select Your
                Seats
              </h3>
              <p class="text-sm text-gray-600 mt-1">
                Click on available seats to select them
              </p>
            </div>

            <div class="p-6">
              <!-- Seat Legend -->
              <div
                class="flex flex-wrap justify-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg"
              >
                <div class="flex items-center">
                  <div
                    class="w-6 h-6 bg-green-500 rounded border-2 border-green-600 mr-2"
                  ></div>
                  <span class="text-sm text-gray-700">Available</span>
                </div>
                <div class="flex items-center">
                  <div
                    class="w-6 h-6 bg-blue-500 rounded border-2 border-blue-600 mr-2"
                  ></div>
                  <span class="text-sm text-gray-700">Selected</span>
                </div>
                <div class="flex items-center">
                  <div
                    class="w-6 h-6 bg-red-500 rounded border-2 border-red-600 mr-2"
                  ></div>
                  <span class="text-sm text-gray-700">Booked</span>
                </div>
                <div class="flex items-center">
                  <div
                    class="w-6 h-6 bg-yellow-500 rounded border-2 border-yellow-600 mr-2"
                  ></div>
                  <span class="text-sm text-gray-700">Reserved</span>
                </div>
              </div>

              <!-- Realistic Bus Layout -->
              <div class="bg-gradient-to-b from-gray-100 to-gray-200 rounded-3xl p-6 max-w-sm mx-auto border-4 border-gray-400 shadow-2xl" style="background: linear-gradient(145deg, #f0f0f0, #d9d9d9);">
                <!-- Front Windshield -->
                <div class="bg-gradient-to-r from-blue-200 to-blue-300 rounded-t-2xl p-2 mb-4 border-2 border-blue-400">
                  <div class="text-center text-blue-800 font-bold text-sm">
                    <i class="fas fa-car-side mr-2"></i>FRONT
                  </div>
                </div>
                
                <!-- Driver Section -->
                <div class="bg-gradient-to-r from-gray-400 to-gray-500 text-white p-3 rounded-xl text-center mb-6 border-2 border-gray-600 shadow-lg">
                  <i class="fas fa-steering-wheel mr-2"></i>Driver
                </div>

                <!-- Seat Rows -->
                <div class="space-y-3">
                  {% for row in seat_layout %}
                    {% if row.left_seats or row.right_seats %}
                      <!-- Regular 2x2 Row -->
                      <div class="flex justify-between items-center">
                        <!-- Left Side (A seats) -->
                        <div class="flex gap-1">
                          {% for seat in row.left_seats %}
                            <div class="seat w-12 h-10 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-all duration-300 text-xs font-bold shadow-md 
                               {% if seat.status == 'booked' %}bg-red-500 border-red-700 text-white cursor-not-allowed
                               {% elif seat.status == 'reserved' %}bg-yellow-500 border-yellow-700 text-white cursor-not-allowed
                               {% else %}bg-green-500 border-green-700 text-white{% endif %}"
                              data-seat-id="{{ seat.id }}"
                              data-seat-number="{{ seat.seat_number }}"
                              data-seat-price="{{ schedule.base_fare }}"
                              {% if seat.status != 'booked' and seat.status != 'reserved' %}onclick="toggleSeat(this)"{% endif %}>
                              {{ seat.seat_number }}
                            </div>
                          {% endfor %}
                        </div>
                        
                        <!-- Aisle -->
                        <div class="w-8 h-10 flex items-center justify-center">
                          <div class="w-1 h-8 bg-gray-400 rounded-full"></div>
                        </div>
                        
                        <!-- Right Side (B seats) -->
                        <div class="flex gap-1">
                          {% for seat in row.right_seats %}
                            <div class="seat w-12 h-10 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-all duration-300 text-xs font-bold shadow-md 
                               {% if seat.status == 'booked' %}bg-red-500 border-red-700 text-white cursor-not-allowed
                               {% elif seat.status == 'reserved' %}bg-yellow-500 border-yellow-700 text-white cursor-not-allowed
                               {% else %}bg-green-500 border-green-700 text-white{% endif %}"
                               data-seat-id="{{ seat.id }}"
                               data-seat-number="{{ seat.seat_number }}"
                               data-seat-price="{{ schedule.base_fare }}"
                               {% if seat.status != 'booked' and seat.status != 'reserved' %}onclick="toggleSeat(this)"{% endif %}>
                               {{ seat.seat_number }}
                             </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                    
                    {% if row.last_row_seats %}
                      <!-- Back Row (5 seats) -->
                      <div class="mt-6 pt-4 border-t-2 border-gray-400">
                        <div class="text-center text-gray-600 text-xs mb-2 font-semibold">BACK ROW</div>
                        <div class="flex justify-center gap-1">
                          {% for seat in row.last_row_seats %}
                            <div class="seat w-10 h-10 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-all duration-300 text-xs font-bold shadow-md 
                               {% if seat.status == 'booked' %}bg-red-500 border-red-700 text-white cursor-not-allowed
                               {% elif seat.status == 'reserved' %}bg-yellow-500 border-yellow-700 text-white cursor-not-allowed
                               {% else %}bg-green-500 border-green-700 text-white{% endif %}"
                              data-seat-id="{{ seat.id }}"
                              data-seat-number="{{ seat.seat_number }}"
                              data-seat-price="{{ schedule.base_fare }}"
                              {% if seat.status != 'booked' and seat.status != 'reserved' %}onclick="toggleSeat(this)"{% endif %}>
                              {{ seat.seat_number }}
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
                
                <!-- Rear Section -->
                <div class="bg-gradient-to-r from-gray-300 to-gray-400 rounded-b-2xl p-2 mt-4 border-2 border-gray-500">
                  <div class="text-center text-gray-700 font-bold text-sm">
                    <i class="fas fa-door-open mr-2"></i>EXIT
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Booking Summary -->
        <div class="lg:col-span-1">
          <div
            class="bg-white rounded-xl shadow-lg overflow-hidden sticky top-4"
          >
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-receipt mr-2 text-green-500"></i>Booking
                Summary
              </h3>
            </div>

            <div class="p-6">
              <div id="selectedSeatsDisplay" class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-2">
                  Selected Seats:
                </h4>
                <div id="seatsList" class="text-gray-500 text-sm">
                  No seats selected
                </div>
              </div>

              <div class="space-y-3 mb-6">
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">Base Fare per seat:</span>
                  <span class="text-sm font-semibold"
                    >रू{{ schedule.base_fare }}</span
                  >
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">Number of seats:</span>
                  <span class="text-sm font-semibold" id="seatCount">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">Subtotal:</span>
                  <span class="text-sm font-semibold" id="subtotal">रू0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-600">Service charge:</span>
                  <span class="text-sm font-semibold"
                    >रू{{ service_charge|default:0 }}</span
                  >
                </div>
                <hr class="border-gray-200" />
                <div class="flex justify-between">
                  <span class="text-lg font-semibold text-gray-800"
                    >Total:</span
                  >
                  <span class="text-lg font-bold text-green-600" id="totalFare"
                    >रू0</span
                  >
                </div>
              </div>

              <form
                method="post"
                action="{% url 'bookings:create_booking' schedule.id %}"
                id="seatSelectionForm"
              >
                {% csrf_token %}
                <input
                  type="hidden"
                  name="schedule_id"
                  value="{{ schedule.id }}"
                />
                <input
                  type="hidden"
                  name="travel_date"
                  value="{{ travel_date|date:'Y-m-d' }}"
                />
                <input
                  type="hidden"
                  name="selected_seats"
                  id="selectedSeatsInput"
                  value=""
                />

                <button
                  type="submit"
                  id="proceedBtn"
                  disabled
                  class="w-full bg-gradient-to-r from-green-600 to-emerald-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-emerald-800 transition-all duration-200 transform hover:scale-105 font-medium disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                >
                  <i class="fas fa-arrow-right mr-2"></i>Proceed to Booking
                </button>
              </form>

              <div class="mt-4 text-center">
                <a
                  href="{% url 'routes:route_search' %}"
                  class="text-sm text-gray-500 hover:text-gray-700"
                >
                  <i class="fas fa-arrow-left mr-1"></i>Back to Search
                </a>
              </div>
            </div>
          </div>

          <!-- Seat Selection Tips -->
          <div class="bg-blue-50 rounded-xl p-6 mt-6 border border-blue-200">
            <h4 class="text-sm font-semibold text-blue-800 mb-3">
              <i class="fas fa-lightbulb mr-2"></i>Seat Selection Tips
            </h4>
            <ul class="text-xs text-blue-700 space-y-2">
              <li class="flex items-start">
                <i class="fas fa-check-circle mr-2 mt-0.5 text-blue-600"></i>
                <span>Window seats offer scenic views</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check-circle mr-2 mt-0.5 text-blue-600"></i>
                <span>Aisle seats provide easy access</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check-circle mr-2 mt-0.5 text-blue-600"></i>
                <span>Front seats have less vibration</span>
              </li>
              <li class="flex items-start">
                <i class="fas fa-check-circle mr-2 mt-0.5 text-blue-600"></i>
                <span>Select seats together for groups</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_js %}
<script>
  let selectedSeats = [];
  const baseFare = {{ schedule.base_fare }};
  const serviceCharge = {{ service_charge|default:0 }};

  function toggleSeat(seatElement) {
      const seatId = seatElement.getAttribute('data-seat-id');
      const seatNumber = seatElement.getAttribute('data-seat-number');
      const seatPrice = parseFloat(seatElement.getAttribute('data-seat-price')) || baseFare;

      if (seatElement.classList.contains('bg-red-500') || seatElement.classList.contains('bg-yellow-500')) {
          return; // Can't select booked or reserved seats
      }

      // Check if seat is already selected
      const existingIndex = selectedSeats.findIndex(seat => seat.id === seatId);

      if (seatElement.classList.contains('bg-blue-500')) {
          // Deselect seat
          seatElement.classList.remove('bg-blue-500', 'border-blue-700');
          seatElement.classList.add('bg-green-500', 'border-green-700');

          selectedSeats = selectedSeats.filter(seat => seat.id !== seatId);
      } else {
          // Select seat
          seatElement.classList.remove('bg-green-500', 'border-green-700');
          seatElement.classList.add('bg-blue-500', 'border-blue-700');

          selectedSeats.push({
              id: seatId,
              number: seatNumber,
              price: seatPrice
          });
      }

      updateBookingSummary();
  }

  function updateBookingSummary() {
      const seatsList = document.getElementById('seatsList');
      const seatCount = document.getElementById('seatCount');
      const subtotal = document.getElementById('subtotal');
      const totalFare = document.getElementById('totalFare');
      const proceedBtn = document.getElementById('proceedBtn');
      const selectedSeatsInput = document.getElementById('selectedSeatsInput');

      if (selectedSeats.length === 0) {
          seatsList.textContent = 'No seats selected';
          seatsList.className = 'text-gray-500 text-sm';
          seatCount.textContent = '0';
          subtotal.textContent = 'रू0';
          totalFare.textContent = 'रू0';
          proceedBtn.disabled = true;
          selectedSeatsInput.value = '';
      } else {
          const seatNumbers = selectedSeats.map(seat => seat.number).sort();
          seatsList.innerHTML = seatNumbers.map(num =>
              `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-1 mb-1">${num}</span>`
          ).join('');
          seatsList.className = 'text-gray-800 text-sm';

          const count = selectedSeats.length;
          const subtotalAmount = count * baseFare;
          const totalAmount = subtotalAmount + serviceCharge;

          seatCount.textContent = count;
          subtotal.textContent = `रू${subtotalAmount}`;
          totalFare.textContent = `रू${totalAmount}`;
          proceedBtn.disabled = false;
          const seatIds = selectedSeats.map(seat => seat.id).join(',');
          selectedSeatsInput.value = seatIds;
      }
  }

  // Form submission
  document.getElementById('seatSelectionForm').addEventListener('submit', function(e) {
      if (selectedSeats.length === 0) {
          e.preventDefault();
          alert('Please select at least one seat.');
          return;
      }

      // Ensure the hidden input is updated with latest selection
      const seatIds = selectedSeats.map(seat => seat.id).join(',');
      document.getElementById('selectedSeatsInput').value = seatIds;

      // Add loading state
      const proceedBtn = document.getElementById('proceedBtn');
      proceedBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
      proceedBtn.disabled = true;

      // Save current selection to localStorage
      saveToLocalStorage();
  });

  // Auto-save selected seats to localStorage
  function saveToLocalStorage() {
      localStorage.setItem('selectedSeats_{{ schedule.id }}', JSON.stringify(selectedSeats));
  }

  function loadFromLocalStorage() {
      const saved = localStorage.getItem('selectedSeats_{{ schedule.id }}');
      if (saved) {
          const savedSeats = JSON.parse(saved);
          savedSeats.forEach(seat => {
              const seatElement = document.querySelector(`[data-seat-id="${seat.id}"]`);
              if (seatElement && !seatElement.classList.contains('bg-red-500') && !seatElement.classList.contains('bg-yellow-500')) {
                  seatElement.classList.remove('bg-green-500', 'border-green-700');
                  seatElement.classList.add('bg-blue-500', 'border-blue-700');
                  selectedSeats.push(seat);
              }
          });
          updateBookingSummary();
      }
  }

  // Load saved seats on page load
  document.addEventListener('DOMContentLoaded', function() {
      // Check if this is a fresh booking session (no form validation errors)
      const preselectedSeatIds = {{ preselected_seat_ids|default:'[]' }};
      const urlParams = new URLSearchParams(window.location.search);
      const isFromFormError = preselectedSeatIds.length > 0;
      const isFromSuccessfulBooking = urlParams.get('booking_success') === 'true';
      
      // Clear localStorage for fresh booking sessions (not form validation errors)
      if (!isFromFormError && !isFromSuccessfulBooking) {
          localStorage.removeItem('selectedSeats_{{ schedule.id }}');
      }
      
      // First, handle preselected seats from backend (form validation errors)
      if (preselectedSeatIds.length > 0) {
          preselectedSeatIds.forEach(seatId => {
              const seatElement = document.querySelector(`[data-seat-id="${seatId}"]`);
              if (seatElement && !seatElement.classList.contains('bg-red-500') && !seatElement.classList.contains('bg-yellow-500')) {
                  const seatNumber = seatElement.getAttribute('data-seat-number');
                  const seatPrice = parseFloat(seatElement.getAttribute('data-seat-price')) || baseFare;
                  seatElement.classList.remove('bg-green-500', 'border-green-700');
                  seatElement.classList.add('bg-blue-500', 'border-blue-700');
                  selectedSeats.push({
                      id: seatId.toString(),
                      number: seatNumber,
                      price: seatPrice
                  });
              }
          });
          updateBookingSummary();
          saveToLocalStorage();
      } else {
          // If no preselected seats, load from localStorage (only for form validation scenarios)
          // For fresh sessions, localStorage was already cleared above
          loadFromLocalStorage();
      }

      // Add smooth animations to seats
      const seats = document.querySelectorAll('.seat');
      seats.forEach((seat, index) => {
          seat.style.opacity = '0';
          seat.style.transform = 'scale(0.8)';

          setTimeout(() => {
              seat.style.transition = 'all 0.3s ease';
              seat.style.opacity = '1';
              seat.style.transform = 'scale(1)';
          }, index * 50);
      });
  });

  // Clear localStorage on successful booking or when no seats selected
  window.addEventListener('beforeunload', function() {
      if (selectedSeats.length === 0) {
          localStorage.removeItem('selectedSeats_{{ schedule.id }}');
      }
  });

  // Function to clear localStorage (can be called from other pages)
  window.clearSeatSelection = function() {
      localStorage.removeItem('selectedSeats_{{ schedule.id }}');
  };

  // Clear localStorage if coming from a successful booking
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('booking_success') === 'true') {
      localStorage.removeItem('selectedSeats_{{ schedule.id }}');
  }

  // Add keyboard navigation
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
          // Clear all selections
          selectedSeats.forEach(seat => {
              const seatElement = document.querySelector(`[data-seat-id="${seat.id}"]`);
              if (seatElement) {
                  seatElement.classList.remove('bg-blue-500', 'border-blue-600');
                  seatElement.classList.add('bg-green-500', 'border-green-600');
              }
          });
          selectedSeats = [];
          updateBookingSummary();
          saveToLocalStorage();
      }
  });
</script>
{% endblock %}
