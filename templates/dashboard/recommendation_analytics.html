{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Recommendation Analytics - Dashboard{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 sm:px-8">
    <div class="py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-semibold leading-tight text-gray-800">
                    <i class="fas fa-chart-line mr-2"></i>Recommendation Analytics
                </h2>
                <p class="text-gray-600">Advanced insights into recommendation system performance</p>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'dashboard:analytics' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Analytics
                </a>
                <button onclick="generateReport()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    <i class="fas fa-download mr-2"></i>Export Report
                </button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-blue-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-eye text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.total_views|default:0 }}</div>
                        <div class="text-sm text-gray-600">Total Views</div>
                        <div class="text-xs text-green-600 flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +{{ metrics.views_change|default:0 }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-green-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-mouse-pointer text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.total_clicks|default:0 }}</div>
                        <div class="text-sm text-gray-600">Total Clicks</div>
                        <div class="text-xs text-green-600 flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +{{ metrics.clicks_change|default:0 }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-purple-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-percentage text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.click_through_rate|default:0|floatformat:1 }}%</div>
                        <div class="text-sm text-gray-600">Click Rate</div>
                        <div class="text-xs text-gray-600 flex items-center mt-1">
                            <i class="fas fa-minus mr-1"></i>
                            {{ metrics.ctr_change|default:0|floatformat:1 }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-orange-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-shopping-cart text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.conversions|default:0 }}</div>
                        <div class="text-sm text-gray-600">Conversions</div>
                        <div class="text-xs text-green-600 flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +{{ metrics.conversion_change|default:0 }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-yellow-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-star text-yellow-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.avg_score|default:0|floatformat:1 }}</div>
                        <div class="text-sm text-gray-600">Avg Score</div>
                        <div class="text-xs text-green-600 flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +{{ metrics.score_change|default:0|floatformat:1 }}%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6 border-t-4 border-indigo-500 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                        <i class="fas fa-users text-indigo-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800">{{ metrics.active_users|default:0 }}</div>
                        <div class="text-sm text-gray-600">Active Users</div>
                        <div class="text-xs text-green-600 flex items-center mt-1">
                            <i class="fas fa-arrow-up mr-1"></i>
                            +{{ metrics.users_change|default:0 }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                <i class="fas fa-filter mr-2 text-blue-500"></i>Analytics Filters
            </h3>
            
            <form method="GET" id="analyticsForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                        <select name="date_range" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="7" {% if request.GET.date_range == '7' %}selected{% endif %}>Last 7 days</option>
                            <option value="30" {% if request.GET.date_range == '30' or not request.GET.date_range %}selected{% endif %}>Last 30 days</option>
                            <option value="90" {% if request.GET.date_range == '90' %}selected{% endif %}>Last 90 days</option>
                            <option value="365" {% if request.GET.date_range == '365' %}selected{% endif %}>Last year</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Recommendation Type</label>
                        <select name="rec_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" {% if not request.GET.rec_type %}selected{% endif %}>All Types</option>
                            <option value="route" {% if request.GET.rec_type == 'route' %}selected{% endif %}>Route Recommendations</option>
                            <option value="bus" {% if request.GET.rec_type == 'bus' %}selected{% endif %}>Bus Recommendations</option>
                            <option value="destination" {% if request.GET.rec_type == 'destination' %}selected{% endif %}>Destination Recommendations</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Segment</label>
                        <select name="user_segment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" {% if not request.GET.user_segment %}selected{% endif %}>All Users</option>
                            <option value="new" {% if request.GET.user_segment == 'new' %}selected{% endif %}>New Users</option>
                            <option value="returning" {% if request.GET.user_segment == 'returning' %}selected{% endif %}>Returning Users</option>
                            <option value="premium" {% if request.GET.user_segment == 'premium' %}selected{% endif %}>Premium Users</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Device Type</label>
                        <select name="device_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" {% if not request.GET.device_type %}selected{% endif %}>All Devices</option>
                            <option value="mobile" {% if request.GET.device_type == 'mobile' %}selected{% endif %}>Mobile</option>
                            <option value="desktop" {% if request.GET.device_type == 'desktop' %}selected{% endif %}>Desktop</option>
                            <option value="tablet" {% if request.GET.device_type == 'tablet' %}selected{% endif %}>Tablet</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Performance Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>Performance Trends
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="updateChart('performance', 'views')" data-active class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">Views</button>
                        <button onclick="updateChart('performance', 'clicks')" class="px-3 py-1 text-xs bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Clicks</button>
                        <button onclick="updateChart('performance', 'conversions')" class="px-3 py-1 text-xs bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Conversions</button>
                    </div>
                </div>
                <div class="h-80">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            
            <!-- Recommendation Types Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-pie mr-2 text-green-500"></i>Recommendation Types
                </h3>
                <div class="h-80">
                    <canvas id="typesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- User Engagement Heatmap -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-fire mr-2 text-orange-500"></i>Weekly Engagement
                </h3>
                <div class="h-80">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>
            
            <!-- Conversion Funnel -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-funnel-dollar mr-2 text-purple-500"></i>Conversion Funnel
                </h3>
                <div class="h-80">
                    <canvas id="funnelChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Top Performing Recommendations -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-trophy mr-2 text-yellow-500"></i>Top Performing Recommendations
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Recommendation</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Views</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">CTR</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Conversions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for rec in top_recommendations %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm text-gray-900">{{ rec.title }}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ rec.views }}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ rec.ctr|floatformat:1 }}%</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ rec.conversions }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">No data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- User Segments Performance -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-users mr-2 text-indigo-500"></i>User Segments Performance
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Segment</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Users</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Engagement</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Conversion</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for segment in user_segments %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">{{ segment.name }}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ segment.users }}</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ segment.engagement|floatformat:1 }}%</td>
                                <td class="px-4 py-2 text-sm text-gray-600">{{ segment.conversion|floatformat:1 }}%</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">No data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Insights and Recommendations -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Key Insights -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Key Insights
                </h3>
                
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-semibold text-blue-800">High Engagement Routes</h4>
                        <p class="text-sm text-blue-700 mt-1">Kathmandu-Pokhara route shows 35% higher engagement than average</p>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-semibold text-green-800">Mobile Performance</h4>
                        <p class="text-sm text-green-700 mt-1">Mobile users have 28% higher conversion rates for recommendations</p>
                    </div>
                    
                    <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                        <h4 class="font-semibold text-orange-800">Peak Hours</h4>
                        <p class="text-sm text-orange-700 mt-1">Recommendations perform best between 9 AM - 11 AM and 6 PM - 8 PM</p>
                    </div>
                </div>
            </div>
            
            <!-- Action Items -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-tasks mr-2 text-purple-500"></i>Recommended Actions
                </h3>
                
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-semibold text-purple-800">Optimize Low-Performing Routes</h4>
                        <p class="text-sm text-purple-700 mt-1">Focus on improving recommendations for routes with CTR below 2%</p>
                        <button class="mt-2 text-xs bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">View Details</button>
                    </div>
                    
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h4 class="font-semibold text-indigo-800">Enhance Mobile Experience</h4>
                        <p class="text-sm text-indigo-700 mt-1">Leverage mobile's higher conversion rate with targeted campaigns</p>
                        <button class="mt-2 text-xs bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600">View Details</button>
                    </div>
                    
                    <div class="p-4 bg-teal-50 rounded-lg">
                        <h4 class="font-semibold text-teal-800">A/B Test New Algorithms</h4>
                        <p class="text-sm text-teal-700 mt-1">Test new recommendation algorithms on 10% of traffic</p>
                        <button class="mt-2 text-xs bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600">View Details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart colors
    const chartColors = {
        primary: '#3B82F6',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        info: '#06B6D4',
        purple: '#8B5CF6'
    };
    
    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: {{ chart_data.performance.labels|safe }},
            datasets: [{
                label: 'Views',
                data: {{ chart_data.performance.views|safe }},
                borderColor: chartColors.primary,
                backgroundColor: chartColors.primary + '20',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Types Chart
    const typesCtx = document.getElementById('typesChart').getContext('2d');
    const typesChart = new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: {{ chart_data.types.labels|safe }},
            datasets: [{
                data: {{ chart_data.types.data|safe }},
                backgroundColor: [
                    chartColors.primary,
                    chartColors.success,
                    chartColors.warning,
                    chartColors.purple
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Heatmap Chart (simplified as bar chart)
    const heatmapCtx = document.getElementById('heatmapChart').getContext('2d');
    const heatmapChart = new Chart(heatmapCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Engagement',
                data: {{ chart_data.heatmap.data|safe }},
                backgroundColor: chartColors.primary + '80'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Funnel Chart (simplified as horizontal bar)
    const funnelCtx = document.getElementById('funnelChart').getContext('2d');
    const funnelChart = new Chart(funnelCtx, {
        type: 'bar',
        data: {
            labels: ['Views', 'Clicks', 'Conversions'],
            datasets: [{
                label: 'Funnel',
                data: {{ chart_data.funnel.data|safe }},
                backgroundColor: [
                    chartColors.info,
                    chartColors.warning,
                    chartColors.success
                ]
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Update chart function
    function updateChart(chartType, metric) {
        // Update active button
        document.querySelectorAll(`[onclick*="${chartType}"]`).forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-gray-300', 'text-gray-700');
        });
        event.target.classList.remove('bg-gray-300', 'text-gray-700');
        event.target.classList.add('bg-blue-500', 'text-white');
        
        // Update chart data based on metric
        if (chartType === 'performance') {
            const newData = {
                views: {{ chart_data.performance.views|safe }},
                clicks: {{ chart_data.performance.clicks|safe }},
                conversions: {{ chart_data.performance.conversions|safe }}
            };
            
            performanceChart.data.datasets[0].data = newData[metric];
            performanceChart.data.datasets[0].label = metric.charAt(0).toUpperCase() + metric.slice(1);
            performanceChart.update();
        }
    }
    
    // Auto-submit form on filter change
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('analyticsForm');
        const selects = form.querySelectorAll('select');
        
        selects.forEach(select => {
            select.addEventListener('change', function() {
                form.submit();
            });
        });
    });
    
    // Generate report function
    function generateReport() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
        btn.disabled = true;
        
        // Simulate report generation
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Report generated successfully! Check your downloads folder.');
        }, 3000);
    }
</script>
{% endblock %}