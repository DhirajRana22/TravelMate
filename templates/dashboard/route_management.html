{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Route Management - Admin Dashboard{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 sm:px-8">
    <div class="py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-semibold leading-tight text-gray-800">
                    <i class="fas fa-route mr-2"></i>Route Management
                </h2>
                <p class="text-gray-600">Manage and monitor all bus routes</p>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'dashboard:dashboard_home' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
                <a href="{% url 'dashboard:route_add' %}" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    <i class="fas fa-plus mr-2"></i>Add Route
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-route text-3xl"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold mb-1">{{ total_routes|default:0 }}</h4>
                        <p class="text-sm opacity-90">Total Routes</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-teal-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold mb-1">{{ active_routes|default:0 }}</h4>
                        <p class="text-sm opacity-90">Active Routes</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-yellow-500 to-orange-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-bus text-3xl"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold mb-1">{{ total_buses_assigned|default:0 }}</h4>
                        <p class="text-sm opacity-90">Buses Assigned</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-lg p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-center">
                    <div class="mr-4">
                        <i class="fas fa-ticket-alt text-3xl"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-bold mb-1">{{ total_bookings|default:0 }}</h4>
                        <p class="text-sm opacity-90">Total Bookings</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-search mr-2 text-blue-500"></i>Search Routes
            </h3>
            
            <form method="get">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                        <input type="text" name="search" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Source, destination, route name..." 
                               value="{{ form.search.value|default:'' }}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Source</label>
                        <input type="text" name="source" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Enter source location" 
                               value="{{ form.source.value|default:'' }}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Destination</label>
                        <input type="text" name="destination" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="Enter destination" 
                               value="{{ form.destination.value|default:'' }}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Status</option>
                            <option value="active" {% if form.status.value == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if form.status.value == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex space-x-2 mt-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <a href="{% url 'dashboard:route_management' %}" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                        <i class="fas fa-times mr-2"></i>Clear
                    </a>
                </div>
            </form>
        </div>

        <!-- Routes List -->
        {% if routes %}
            <div class="space-y-4">
                {% for route in routes %}
                <div class="bg-white rounded-lg shadow hover:shadow-md transition-shadow border border-gray-200">
                    <div class="p-6">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center">
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white text-2xl mr-4">
                                    <i class="fas fa-route"></i>
                                </div>
                                
                                <div>
                                    <div class="flex items-center mb-2">
                                        <h3 class="text-xl font-semibold text-gray-800 mr-3">
                                            {{ route.source }} â†’ {{ route.destination }}
                                        </h3>
                                        <span class="px-3 py-1 rounded-full text-sm font-semibold {% if route.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                            {% if route.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </div>
                                    
                                    <div class="flex items-center text-gray-600 text-sm space-x-4">
                                        <span><i class="fas fa-road mr-1"></i>{{ route.distance }} km</span>
                                        <span><i class="fas fa-clock mr-1"></i>{{ route.travel_time }}</span>
                                        <span><i class="fas fa-bus mr-1"></i>{{ route.assigned_buses_count|default:0 }} buses</span>
                                        <span><i class="fas fa-ticket-alt mr-1"></i>{{ route.total_bookings|default:0 }} bookings</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <a href="{% url 'dashboard:route_detail' route.id %}" 
                                   class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View
                                </a>
                                
                                <button onclick="editRoute({{ route.id }})" 
                                        class="bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 text-sm">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                
                                {% if route.is_active %}
                                    <button onclick="toggleRouteStatus({{ route.id }}, false)" 
                                            class="bg-orange-500 text-white px-3 py-2 rounded-lg hover:bg-orange-600 text-sm">
                                        <i class="fas fa-pause mr-1"></i>Deactivate
                                    </button>
                                {% else %}
                                    <button onclick="toggleRouteStatus({{ route.id }}, true)" 
                                            class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm">
                                        <i class="fas fa-play mr-1"></i>Activate
                                    </button>
                                {% endif %}
                                
                                <button onclick="manageBuses({{ route.id }})" 
                                        class="bg-purple-500 text-white px-3 py-2 rounded-lg hover:bg-purple-600 text-sm">
                                    <i class="fas fa-bus mr-1"></i>Buses
                                </button>
                                
                                <button onclick="deleteRoute({{ route.id }}, '{{ route.source }} â†’ {{ route.destination }}')" 
                                        class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Route Details -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>
                                        <div>
                                            <p class="text-xs text-gray-500">Distance</p>
                                            <p class="font-semibold">{{ route.distance }} km</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock text-green-500 mr-2"></i>
                                        <div>
                                            <p class="text-xs text-gray-500">Travel Time</p>
                                            <p class="font-semibold">{{ route.travel_time }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-bus text-purple-500 mr-2"></i>
                                        <div>
                                            <p class="text-xs text-gray-500">Assigned Buses</p>
                                            <p class="font-semibold">{{ route.assigned_buses_count|default:0 }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar text-orange-500 mr-2"></i>
                                        <div>
                                            <p class="text-xs text-gray-500">Created</p>
                                            <p class="font-semibold">{{ route.created_at|date:"M d, Y" }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
            <div class="mt-6 flex justify-center">
                <nav class="flex space-x-2">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.source %}&source={{ request.GET.source }}{% endif %}{% if request.GET.destination %}&destination={{ request.GET.destination }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                           class="px-3 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Previous
                        </a>
                    {% endif %}
                    
                    <span class="px-3 py-2 bg-blue-500 text-white rounded-lg">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.source %}&source={{ request.GET.source }}{% endif %}{% if request.GET.destination %}&destination={{ request.GET.destination }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                           class="px-3 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Next
                        </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-12">
                <i class="fas fa-route text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No Routes Found</h3>
                {% if request.GET.search or request.GET.source or request.GET.destination or request.GET.status %}
                    <p class="text-gray-500 mb-4">No routes match your search criteria.</p>
                    <a href="{% url 'dashboard:route_management' %}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-times mr-2"></i>Clear Filters
                    </a>
                {% else %}
                    <p class="text-gray-500 mb-4">Start by adding your first route to connect different locations.</p>
                    <a href="{% url 'dashboard:route_add' %}" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Add First Route
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block dashboard_extra_js %}
<script>
    function addNewRoute() {
        window.location.href = '/dashboard/routes/add/';
    }
    
    function editRoute(routeId) {
        window.location.href = `/dashboard/routes/${routeId}/edit/`;
    }
    
    function manageBuses(routeId) {
        window.location.href = `/dashboard/routes/${routeId}/buses/`;
    }
    
    function toggleRouteStatus(routeId, activate) {
        const action = activate ? 'activate' : 'deactivate';
        const message = `Are you sure you want to ${action} this route?`;
        
        if (confirm(message)) {
            fetch(`/dashboard/routes/${routeId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ active: activate })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating route status: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating route status.');
            });
        }
    }
    
    function deleteRoute(routeId, routeName) {
        const message = `Are you sure you want to delete route "${routeName}"? This action cannot be undone and will affect all associated bookings.`;
        
        if (confirm(message)) {
            const reason = prompt('Please enter a reason for deletion:');
            if (reason) {
                fetch(`/dashboard/routes/${routeId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting route: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the route.');
                });
            }
        }
    }
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    }
    
    // Add CSRF token to page if not present
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            document.body.appendChild(csrfToken);
        }
        
        // Auto-submit search form on Enter
        const searchInputs = document.querySelectorAll('input[name="search"], input[name="source"], input[name="destination"]');
        searchInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    this.form.submit();
                }
            });
        });
        
        // Auto-submit form on select change
        const selectElements = document.querySelectorAll('select[name="status"]');
        selectElements.forEach(select => {
            select.addEventListener('change', function() {
                this.form.submit();
            });
        });
    });
</script>
{% endblock %}