{% extends "dashboard/base.html" %} {% load static %} {% block title %}Manage
Buses - {{ route.source.name }} to {{ route.destination.name }}{% endblock %} {%
block dashboard_content %}
<div class="container mx-auto px-4 sm:px-8">
  <div class="py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-2xl font-semibold leading-tight text-gray-800">
          <i class="fas fa-bus mr-2"></i>Manage Buses for Route
        </h2>
        <p class="text-gray-600">
          {{ route.source.name }} → {{ route.destination.name }}
        </p>
      </div>
      <div class="flex space-x-2">
        <a
          href="{% url 'dashboard:route_detail' route.id %}"
          class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600"
        >
          <i class="fas fa-arrow-left mr-2"></i>Back to Route
        </a>
        <a
          href="{% url 'dashboard:route_management' %}"
          class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
        >
          <i class="fas fa-list mr-2"></i>All Routes
        </a>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %} {% for message in messages %}
    <div
      class="mb-4 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}"
    >
      <div class="flex justify-between items-center">
        <span>{{ message }}</span>
        <button
          onclick="this.parentElement.parentElement.remove()"
          class="text-gray-500 hover:text-gray-700"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    {% endfor %} {% endif %}

    <!-- Route Information -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h3
        class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2"
      >
        <i class="fas fa-info-circle mr-2 text-blue-500"></i>Route Information
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
          <div class="flex items-center">
            <i class="fas fa-road text-blue-500 text-xl mr-3"></i>
            <div>
              <p class="text-sm text-gray-600">Distance</p>
              <p class="text-lg font-semibold text-gray-800">
                {{ route.distance }} km
              </p>
            </div>
          </div>
        </div>

        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
          <div class="flex items-center">
            <i class="fas fa-clock text-green-500 text-xl mr-3"></i>
            <div>
              <p class="text-sm text-gray-600">Travel Time</p>
              <p class="text-lg font-semibold text-gray-800">
                {{ route.travel_time }}
              </p>
            </div>
          </div>
        </div>

        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
          <div class="flex items-center">
            <i
              class="fas fa-toggle-{% if route.is_active %}on text-green-500{% else %}off text-red-500{% endif %} text-xl mr-3"
            ></i>
            <div>
              <p class="text-sm text-gray-600">Status</p>
              <span
                class="px-2 py-1 rounded-full text-sm font-semibold {% if route.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
              >
                {% if route.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </div>
          </div>
        </div>

        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
          <div class="flex items-center">
            <i class="fas fa-bus text-orange-500 text-xl mr-3"></i>
            <div>
              <p class="text-sm text-gray-600">Assigned Buses</p>
              <p class="text-lg font-semibold text-gray-800">
                {{ current_schedules.count }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Currently Assigned Buses -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div
        class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2"
      >
        <h3 class="text-lg font-semibold text-gray-800">
          <i class="fas fa-bus mr-2 text-blue-500"></i>Currently Assigned Buses
          ({{ current_schedules.count }})
        </h3>
      </div>

      {% if current_schedules %}
      <div class="space-y-4">
        {% for schedule in current_schedules %}
        <div
          class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
        >
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <div
                  class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white text-sm font-bold mr-3"
                >
                  {{ schedule.bus.bus_number|slice:":2" }}
                </div>
                <div>
                  <h4 class="font-semibold text-gray-800">
                    {{ schedule.bus.bus_number }}
                  </h4>
                  <p class="text-sm text-gray-600">
                    {{ schedule.bus.bus_name }}
                  </p>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-gray-500">Departure:</span>
                  <span class="font-medium">{{ schedule.departure_time }}</span>
                </div>
                <div>
                  <span class="text-gray-500">Arrival:</span>
                  <span class="font-medium">{{ schedule.arrival_time }}</span>
                </div>
                <div>
                  <span class="text-gray-500">Fare:</span>
                  <span class="font-medium">रू{{ schedule.base_fare }}</span>
                </div>
                <div>
                  <span class="text-gray-500">Type:</span>
                  <span class="font-medium"
                    >{{ schedule.schedule_type|title }}</span
                  >
                </div>
              </div>
            </div>

            <div class="flex space-x-2 ml-4">
              <a
                href="{% url 'dashboard:update_schedule' schedule.id %}"
                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
              >
                <i class="fas fa-edit mr-1"></i>Edit
              </a>

              <form
                method="post"
                class="inline"
                onsubmit="return confirm('Are you sure you want to remove this bus assignment?')"
              >
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_schedule" />
                <input
                  type="hidden"
                  name="schedule_id"
                  value="{{ schedule.id }}"
                />
                <button
                  type="submit"
                  class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600"
                >
                  <i class="fas fa-trash mr-1"></i>Remove
                </button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8">
        <i class="fas fa-bus text-6xl text-gray-300 mb-4"></i>
        <h4 class="text-lg font-semibold text-gray-600 mb-2">
          No Buses Assigned
        </h4>
        <p class="text-gray-500">
          Assign buses to this route to start scheduling trips.
        </p>
      </div>
      {% endif %}
    </div>

    <!-- Assign New Bus -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3
        class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2"
      >
        <i class="fas fa-plus mr-2 text-green-500"></i>Assign New Bus
      </h3>

      <form method="post" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="action" value="assign_bus" />

        <!-- Bus Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="bus_id"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Select Bus <span class="text-red-500">*</span></label
            >
            <select
              name="bus_id"
              id="bus_id"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              required
            >
              <option value="">Choose a bus...</option>
              {% for bus in available_buses %}
              <option value="{{ bus.id }}">
                {{ bus.bus_number }} - {{ bus.bus_name }} ({{ bus.total_seats }}
                seats)
              </option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label
              for="base_fare"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Base Fare (रू) <span class="text-red-500">*</span></label
            >
            <input
              type="number"
              name="base_fare"
              id="base_fare"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              placeholder="1500"
              min="1"
              step="0.01"
              required
            />
          </div>
        </div>

        <!-- Schedule Times -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="departure_time"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Departure Time <span class="text-red-500">*</span></label
            >
            <input
              type="time"
              name="departure_time"
              id="departure_time"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>

          <div>
            <label
              for="arrival_time"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Arrival Time <span class="text-red-500">*</span></label
            >
            <input
              type="time"
              name="arrival_time"
              id="arrival_time"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>
        </div>

        <!-- Schedule Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label
              for="effective_from"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Effective From</label
            >
            <input
              type="date"
              name="effective_from"
              id="effective_from"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label
              for="effective_until"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Effective Until (Optional)</label
            >
            <input
              type="date"
              name="effective_until"
              id="effective_until"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label
              for="schedule_type"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Schedule Type</label
            >
            <select
              name="schedule_type"
              id="schedule_type"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="regular">Regular</option>
              <option value="express">Express</option>
              <option value="deluxe">Deluxe</option>
              <option value="night">Night Service</option>
            </select>
          </div>
        </div>

        <!-- Advanced Settings -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="days_of_week"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Days of Week</label
            >
            <input
              type="text"
              name="days_of_week"
              id="days_of_week"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              placeholder="1234567"
              value="1234567"
            />
            <p class="text-sm text-gray-500 mt-1">
              1=Monday, 2=Tuesday, ..., 7=Sunday (e.g., 1234567 for all days)
            </p>
          </div>

          <div>
            <label
              for="buffer_hours"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Buffer Hours</label
            >
            <input
              type="number"
              name="buffer_hours"
              id="buffer_hours"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
              placeholder="2"
              min="0"
              step="0.5"
              value="2"
            />
            <p class="text-sm text-gray-500 mt-1">
              Buffer time between consecutive trips for the same bus
            </p>
          </div>
        </div>

        <!-- Return Schedule Option -->
        <div class="flex items-center">
          <input
            type="checkbox"
            id="return_schedule_enabled"
            name="return_schedule_enabled"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <label
            for="return_schedule_enabled"
            class="ml-2 block text-sm text-gray-700"
          >
            <span class="font-medium">Enable Return Schedule</span>
            <p class="text-gray-500 text-xs">
              Automatically create a return trip schedule
            </p>
          </label>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors"
          >
            <i class="fas fa-plus mr-2"></i>Assign Bus to Route
          </button>
        </div>
      </form>
    </div>

    <!-- Quick Actions -->
    <div class="mt-6 flex justify-center space-x-4">
      <a
        href="{% url 'dashboard:bus_management' %}"
        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
      >
        <i class="fas fa-bus mr-2"></i>Manage Buses
      </a>
      <a
        href="{% url 'dashboard:route_detail' route.id %}"
        class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600"
      >
        <i class="fas fa-info-circle mr-2"></i>Route Details
      </a>
    </div>
  </div>
</div>
{% endblock %} {% block dashboard_extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Form validation
    const form = document.querySelector('form[method="post"]');
    if (form) {
      form.addEventListener("submit", function (e) {
        const busSelect = document.getElementById("bus_id");
        const departureTime = document.getElementById("departure_time");
        const arrivalTime = document.getElementById("arrival_time");
        const baseFare = document.getElementById("base_fare");

        // Validate required fields
        if (
          !busSelect.value ||
          !departureTime.value ||
          !arrivalTime.value ||
          !baseFare.value
        ) {
          e.preventDefault();
          alert("Please fill in all required fields.");
          return;
        }

        // Validate time logic
        if (departureTime.value >= arrivalTime.value) {
          e.preventDefault();
          alert("Arrival time must be after departure time.");
          return;
        }

        // Validate fare
        if (parseFloat(baseFare.value) <= 0) {
          e.preventDefault();
          alert("Base fare must be greater than 0.");
          return;
        }
      });
    }

    // Auto-calculate arrival time based on route travel time
    const departureInput = document.getElementById("departure_time");
    const arrivalInput = document.getElementById("arrival_time");

    if (departureInput && arrivalInput) {
      departureInput.addEventListener("change", function () {
        if (this.value && !arrivalInput.value) {
          // Add route travel time to departure time
          const departure = new Date("2000-01-01 " + this.value);
          // Assuming route travel time is available, add it
          // For now, add 6 hours as default
          departure.setHours(departure.getHours() + 6);

          const hours = departure.getHours().toString().padStart(2, "0");
          const minutes = departure.getMinutes().toString().padStart(2, "0");
          arrivalInput.value = `${hours}:${minutes}`;
        }
      });
    }

    // Days of week helper
    const daysInput = document.getElementById("days_of_week");
    if (daysInput) {
      daysInput.addEventListener("input", function () {
        // Validate days format
        const value = this.value.replace(/[^1-7]/g, "");
        if (value !== this.value) {
          this.value = value;
        }
      });
    }

    // Auto-dismiss messages after 5 seconds
    setTimeout(function () {
      const messages = document.querySelectorAll(
        '[class*="bg-green-100"], [class*="bg-red-100"], [class*="bg-yellow-100"], [class*="bg-blue-100"]'
      );
      messages.forEach((message) => {
        if (message.querySelector("button")) {
          setTimeout(() => {
            message.style.opacity = "0";
            message.style.transition = "opacity 0.5s";
            setTimeout(() => message.remove(), 500);
          }, 5000);
        }
      });
    }, 100);
  });
</script>
{% endblock %}
