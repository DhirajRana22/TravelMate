{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}{% if is_edit %}Edit Driver{% else %}Add Driver{% endif %} - Dashboard{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 sm:px-8">
    <div class="py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-semibold leading-tight text-gray-800">
                        <i class="fas fa-{% if is_edit %}edit{% else %}plus{% endif %} mr-2"></i>
                        {% if is_edit %}Edit Driver{% else %}Add New Driver{% endif %}
                    </h2>
                    <p class="text-gray-600">{% if is_edit %}Update driver information for {{ driver.name }}{% else %}Create a new driver profile{% endif %}</p>
                </div>
                <a href="{% url 'dashboard:driver_management' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Drivers
                </a>
            </div>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Driver Information Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-user mr-2 text-blue-500"></i>Driver Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                                Driver Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="name" name="name" 
                                   value="{% if is_edit %}{{ driver.name }}{% endif %}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Enter full name" required maxlength="100">
                            <p class="text-sm text-gray-500 mt-1">Full name of the driver</p>
                        </div>
                        
                        <div>
                            <label for="license_number" class="block text-sm font-medium text-gray-700 mb-2">
                                License Number <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="license_number" name="license_number" 
                                   value="{% if is_edit %}{{ driver.license_number }}{% endif %}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Enter license number" required maxlength="20">
                            <p class="text-sm text-gray-500 mt-1">Unique driving license number</p>
                        </div>
                    </div>
                </div>

                <!-- Contact & Experience Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-phone mr-2 text-green-500"></i>Contact & Experience
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contact_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Contact Number
                            </label>
                            <input type="tel" id="contact_number" name="contact_number" 
                                   value="{% if is_edit %}{{ driver.contact_number }}{% endif %}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Enter phone number" maxlength="15">
                            <p class="text-sm text-gray-500 mt-1">Phone number for contact (optional)</p>
                        </div>
                        
                        <div>
                            <label for="experience_years" class="block text-sm font-medium text-gray-700 mb-2">
                                Experience (Years)
                            </label>
                            <input type="number" id="experience_years" name="experience_years" 
                                   value="{% if is_edit %}{{ driver.experience_years }}{% else %}0{% endif %}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Years of experience" min="0" max="50">
                            <p class="text-sm text-gray-500 mt-1">Years of driving experience</p>
                        </div>
                    </div>
                </div>

                <!-- Bus Assignment Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-bus mr-2 text-purple-500"></i>Bus Assignment
                    </h3>
                    
                    <div>
                        <label for="bus" class="block text-sm font-medium text-gray-700 mb-2">
                            Assign to Bus
                        </label>
                        <select id="bus" name="bus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- No Bus Assignment --</option>
                            {% for bus in available_buses %}
                                <option value="{{ bus.id }}" 
                                        {% if is_edit and driver.bus and driver.bus.id == bus.id %}selected{% endif %}>
                                    {{ bus.bus_number }} - {{ bus.route.name }} 
                                    ({{ bus.route.origin }} â†’ {{ bus.route.destination }})
                                </option>
                            {% endfor %}
                        </select>
                        
                        {% if is_edit and driver.bus %}
                            <div class="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Currently assigned to: <strong>{{ driver.bus.bus_number }}</strong>
                                </p>
                            </div>
                        {% else %}
                            <p class="text-sm text-gray-500 mt-1">Select a bus to assign this driver (optional)</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Driver Statistics (if editing) -->
                {% if is_edit and driver_stats %}
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                        <i class="fas fa-chart-bar mr-2 text-orange-500"></i>Driver Statistics
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                            <div class="text-2xl font-bold text-blue-600">{{ driver_stats.total_trips|default:0 }}</div>
                            <div class="text-sm text-gray-600">Total Trips</div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                            <div class="text-2xl font-bold text-green-600">{{ driver_stats.total_distance|default:0 }} km</div>
                            <div class="text-sm text-gray-600">Distance Covered</div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                            <div class="text-2xl font-bold text-purple-600">{{ driver_stats.rating|floatformat:1|default:"N/A" }}</div>
                            <div class="text-sm text-gray-600">Average Rating</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row justify-between gap-4">
                    <a href="{% url 'dashboard:driver_management' %}" 
                       class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-colors text-center">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Drivers
                    </a>
                    
                    <div class="flex flex-col sm:flex-row gap-2">
                        {% if is_edit %}
                            <a href="{% url 'dashboard:driver_delete' driver.id %}" 
                               class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors text-center"
                               onclick="return confirm('Are you sure you want to delete this driver?')">
                                <i class="fas fa-trash mr-2"></i>Delete Driver
                            </a>
                        {% endif %}
                        
                        <button type="submit" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-save mr-2"></i>
                            {% if is_edit %}Update Driver{% else %}Add Driver{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('name').value.trim();
            const license = document.getElementById('license_number').value.trim();
            
            if (!name || !license) {
                e.preventDefault();
                alert('Name and License Number are required fields.');
                return false;
            }
            
            // Validate license number format (basic check)
            if (license.length < 5) {
                e.preventDefault();
                alert('License number should be at least 5 characters long.');
                return false;
            }
        });
        
        // Auto-format phone number
        document.getElementById('contact_number').addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            this.value = value;
        });
        
        // Real-time validation feedback
        const nameInput = document.getElementById('name');
        const licenseInput = document.getElementById('license_number');
        
        function validateField(field, minLength = 1) {
            const value = field.value.trim();
            if (value.length >= minLength) {
                field.classList.remove('border-red-500');
                field.classList.add('border-green-500');
            } else {
                field.classList.remove('border-green-500');
                field.classList.add('border-red-500');
            }
        }
        
        nameInput.addEventListener('input', () => validateField(nameInput));
        licenseInput.addEventListener('input', () => validateField(licenseInput, 5));
        
        // Auto-capitalize name
        nameInput.addEventListener('input', function() {
            const words = this.value.split(' ');
            const capitalizedWords = words.map(word => {
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }
                return word;
            });
            this.value = capitalizedWords.join(' ');
        });
        
        // License number formatting
        licenseInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
</script>
{% endblock %}