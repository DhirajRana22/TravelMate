{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Update Schedule - Dashboard{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 sm:px-8">
    <div class="py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-semibold leading-tight text-gray-800">
                        <i class="fas fa-clock mr-2"></i>Update Schedule
                    </h2>
                    <p class="text-gray-600">
                        {{ route.source }} → {{ route.destination }} | Bus: {{ schedule.bus.bus_number }}
                    </p>
                </div>
                <div class="flex space-x-2">
                    <a href="{% url 'dashboard:route_bus_management' route.id %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Route
                    </a>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}">
                        <div class="flex justify-between items-center">
                            <span>{{ message }}</span>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Schedule Information -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>Current Schedule Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="flex items-center">
                            <i class="fas fa-bus text-blue-500 text-xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Bus</p>
                                <p class="text-lg font-semibold text-gray-800">{{ schedule.bus.bus_number }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <div class="flex items-center">
                            <i class="fas fa-route text-green-500 text-xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Route</p>
                                <p class="text-lg font-semibold text-gray-800">{{ route.source }} → {{ route.destination }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                        <div class="flex items-center">
                            <i class="fas fa-calendar text-purple-500 text-xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Created</p>
                                <p class="text-lg font-semibold text-gray-800">{{ schedule.created_at|date:"M d, Y" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
                        <div class="flex items-center">
                            <i class="fas fa-toggle-{% if schedule.is_active %}on text-green-500{% else %}off text-red-500{% endif %} text-xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Status</p>
                                <p class="text-lg font-semibold text-gray-800">{% if schedule.is_active %}Active{% else %}Inactive{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Form -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-edit mr-2 text-green-500"></i>Update Schedule Details
                </h3>
                
                <form method="post" class="space-y-6" data-travel-minutes="{{ travel_minutes }}">
                    {% csrf_token %}
                    
                    <!-- Schedule Times -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="departure_time" class="block text-sm font-medium text-gray-700 mb-2">
                                Departure Time <span class="text-red-500">*</span>
                            </label>
                            <input type="time" name="departure_time" id="departure_time" 
                                   value="{{ schedule.departure_time|time:'H:i' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div>
                            <label for="arrival_time" class="block text-sm font-medium text-gray-700 mb-2">
                                Arrival Time <span class="text-red-500">*</span>
                            </label>
                            <input type="time" name="arrival_time" id="arrival_time" 
                                   value="{{ schedule.arrival_time|time:'H:i' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                            <p id="nextDayHint" class="text-xs text-yellow-600 mt-1 hidden">Arrival next day</p>
                        </div>
                    </div>
                    
                    <!-- Fare and Schedule Type -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="base_fare" class="block text-sm font-medium text-gray-700 mb-2">
                                Base Fare (रू) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="base_fare" id="base_fare" 
                                   value="{{ schedule.base_fare }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   min="1" step="0.01" required>
                        </div>
                        
                        <div>
                            <label for="schedule_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Schedule Type
                            </label>
                            <select name="schedule_type" id="schedule_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="regular" {% if schedule.schedule_type == 'regular' %}selected{% endif %}>Regular</option>
                                <option value="express" {% if schedule.schedule_type == 'express' %}selected{% endif %}>Express</option>
                                <option value="deluxe" {% if schedule.schedule_type == 'deluxe' %}selected{% endif %}>Deluxe</option>
                                <option value="night" {% if schedule.schedule_type == 'night' %}selected{% endif %}>Night Service</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Effective Dates -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="effective_from" class="block text-sm font-medium text-gray-700 mb-2">
                                Effective From
                            </label>
                            <input type="date" name="effective_from" id="effective_from" 
                                   value="{{ schedule.effective_from|date:'Y-m-d' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label for="effective_until" class="block text-sm font-medium text-gray-700 mb-2">
                                Effective Until (Optional)
                            </label>
                            <input type="date" name="effective_until" id="effective_until" 
                                   value="{{ schedule.effective_until|date:'Y-m-d' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="days_of_week" class="block text-sm font-medium text-gray-700 mb-2">
                                Days of Week
                            </label>
                            <input type="text" name="days_of_week" id="days_of_week" 
                                   value="{{ schedule.days_of_week }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="1234567">
                            <p class="text-sm text-gray-500 mt-1">1=Monday, 2=Tuesday, ..., 7=Sunday (e.g., 1234567 for all days)</p>
                        </div>
                        
                        <div>
                            <label for="buffer_hours" class="block text-sm font-medium text-gray-700 mb-2">
                                Buffer Hours
                            </label>
                            <input type="number" name="buffer_hours" id="buffer_hours" 
                                   value="{{ schedule.buffer_hours }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                   min="0" max="24" step="0.5">
                            <p class="text-sm text-gray-500 mt-1">Buffer time between consecutive trips for the same bus</p>
                        </div>
                    </div>
                    
                    <!-- Schedule Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="return_schedule_enabled" name="return_schedule_enabled" 
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                                   {% if schedule.return_schedule_enabled %}checked{% endif %}>
                            <label for="return_schedule_enabled" class="ml-2 block text-sm text-gray-700">
                                <span class="font-medium">Enable Return Schedule</span>
                                <p class="text-gray-500 text-xs">Automatically create return trip schedule</p>
                            </label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="is_active" name="is_active" 
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                                   {% if schedule.is_active %}checked{% endif %}>
                            <label for="is_active" class="ml-2 block text-sm text-gray-700">
                                <span class="font-medium">Active Schedule</span>
                                <p class="text-gray-500 text-xs">Schedule is available for booking</p>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row justify-between gap-4 pt-4">
                        <a href="{% url 'dashboard:route_bus_management' route.id %}" 
                           class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition-colors text-center">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                        
                        <button type="submit" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-save mr-2"></i>Update Schedule
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Schedule Statistics (if available) -->
            {% if schedule_stats %}
            <div class="bg-white rounded-lg shadow p-6 mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                    <i class="fas fa-chart-bar mr-2 text-purple-500"></i>Schedule Performance
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="text-2xl font-bold text-blue-600">{{ schedule_stats.total_bookings|default:0 }}</div>
                        <div class="text-sm text-gray-600">Total Bookings</div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <div class="text-2xl font-bold text-green-600">{{ schedule_stats.avg_occupancy|floatformat:1|default:0 }}%</div>
                        <div class="text-sm text-gray-600">Average Occupancy</div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                        <div class="text-2xl font-bold text-purple-600">रू{{ schedule_stats.total_revenue|floatformat:0|default:0 }}</div>
                        <div class="text-sm text-gray-600">Total Revenue</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const departureTime = document.getElementById('departure_time').value;
            const arrivalTime = document.getElementById('arrival_time').value;
            const baseFare = document.getElementById('base_fare').value;
            
            // Validate required fields
            if (!departureTime || !arrivalTime || !baseFare) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return;
            }
            
            // Validate time logic allowing overnight arrivals
            const toMinutes = (t) => { const [h,m]=t.split(':').map(Number); return h*60+m; };
            const depMin = toMinutes(departureTime);
            const arrMin = toMinutes(arrivalTime);
            const effectiveArrMin = arrMin <= depMin ? arrMin + 1440 : arrMin;
            if (effectiveArrMin === depMin) {
                e.preventDefault();
                alert('Arrival time cannot be the same as departure time.');
                return;
            }
            
            // Validate fare
            if (parseFloat(baseFare) <= 0) {
                e.preventDefault();
                alert('Base fare must be greater than 0.');
                return;
            }
        });
        
        // Days of week helper
        const daysInput = document.getElementById('days_of_week');
        if (daysInput) {
            daysInput.addEventListener('input', function() {
                // Validate days format
                const value = this.value.replace(/[^1-7]/g, '');
                if (value !== this.value) {
                    this.value = value;
                }
            });
        }
        
        // Auto-dismiss messages after 5 seconds
        setTimeout(function() {
            const messages = document.querySelectorAll('[class*="bg-green-100"], [class*="bg-red-100"], [class*="bg-yellow-100"], [class*="bg-blue-100"]');
            messages.forEach(message => {
                if (message.querySelector('button')) {
                    setTimeout(() => {
                        message.style.opacity = '0';
                        message.style.transition = 'opacity 0.5s';
                        setTimeout(() => message.remove(), 500);
                    }, 5000);
                }
            });
        }, 100);
        
        // Real-time validation feedback
        const timeInputs = document.querySelectorAll('input[type="time"]');
        timeInputs.forEach(input => {
            input.addEventListener('change', function() {
                const departure = document.getElementById('departure_time').value;
                const arrival = document.getElementById('arrival_time').value;
                
                if (departure && arrival) {
                    const toMinutes = (t) => { const [h,m]=t.split(':').map(Number); return h*60+m; };
                    const depMin = toMinutes(departure);
                    const arrMin = toMinutes(arrival);
                    const effectiveArrMin = arrMin <= depMin ? arrMin + 1440 : arrMin;
                    const hint = document.getElementById('nextDayHint');
                    if (hint) { if (arrMin <= depMin) hint.classList.remove('hidden'); else hint.classList.add('hidden'); }
                    if (effectiveArrMin === depMin) {
                        this.classList.add('border-red-500');
                        this.classList.remove('border-gray-300');
                    } else {
                        this.classList.remove('border-red-500');
                        this.classList.add('border-gray-300');
                    }
                }
            });
        });

        const formEl = document.querySelector('form[method="post"]');
        const travelMinutes = parseInt(formEl ? formEl.getAttribute('data-travel-minutes') || '360' : '360', 10);
        const depInput = document.getElementById('departure_time');
        const arrInput = document.getElementById('arrival_time');
        if (depInput && arrInput) {
            depInput.addEventListener('change', function() {
                if (this.value) {
                    const [h,m] = this.value.split(':').map(Number);
                    let minutes = h*60 + m + travelMinutes;
                    minutes = minutes % 1440;
                    const hh = String(Math.floor(minutes/60)).padStart(2,'0');
                    const mm = String(minutes % 60).padStart(2,'0');
                    arrInput.value = `${hh}:${mm}`;
                    const hint = document.getElementById('nextDayHint');
                    if (hint) { if ((h*60+m) >= (hh*60+parseInt(mm))) hint.classList.remove('hidden'); else hint.classList.add('hidden'); }
                }
            });
        }
    });
</script>
{% endblock %}